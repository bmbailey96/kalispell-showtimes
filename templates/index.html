<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalispell Showtimes</title>
  <style>
    :root{
      --bg:#0b0b0f;
      --panel:#10101a;
      --panel2:#141421;
      --border:#23233a;
      --text:#eaeaf2;
      --muted:rgba(234,234,242,.72);
      --muted2:rgba(234,234,242,.55);
      --bead:#161625;
      --beadBorder:#2b2b49;
      --beadDim:#0f0f19;
      --accent:#9ad1ff;

      /* badges */
      --warnBg:#2a0f16;
      --warnBorder:#5a1b2a;
      --warnText:#ffd6de;

      --shortBg:#1a1a12;
      --shortBorder:#4b4420;
      --shortText:#fff1b8;

      /* today bead */
      --todayBg:#1d2a3a;
      --todayBorder:#6bb8ff;

      --shadow: 0 8px 24px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:24px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{ max-width:1100px; margin:0 auto; }
    h1{ margin:0 0 10px; font-size:26px; letter-spacing:.2px; }
    .sub{ opacity:.8; margin-bottom:18px; max-width: 75ch; }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin:16px 0 18px;
      padding:14px;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow: var(--shadow);
    }

    label{ opacity:.85; font-size:13px; }
    input[type="number"]{
      width:92px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--beadBorder);
      background:var(--beadDim);
      color:var(--text);
      outline:none;
    }

    .btn{
      padding:9px 12px;
      border-radius:10px;
      border:1px solid var(--beadBorder);
      background:#1c1c2e;
      color:var(--text);
      cursor:pointer;
      user-select:none;
      font-size:13px;
    }
    .btn:hover{ background:#23233a; }

    .btn.primary{
      border-color: rgba(154,209,255,.6);
      background: rgba(154,209,255,.10);
    }

    .btn.sort{ background:#161625; }
    .btn.sort.active{
      border-color: rgba(154,209,255,.7);
      background: rgba(154,209,255,.14);
    }

    .toggle{
      display:flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--beadBorder);
      background:#161625;
      cursor:pointer;
      font-size:13px;
      user-select:none;
    }
    .toggle input{ accent-color: var(--accent); }

    .meta{
      font-size:13px;
      opacity:.75;
      margin:10px 0 18px;
      white-space:pre-wrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 860px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .card{
      padding:14px 14px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--panel);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }

    .titleRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }

    .title{
      font-size:16px;
      font-weight:650;
      line-height:1.15;
      margin:0;
    }

    .badges{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      max-width: 52%;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--beadBorder);
      background:#0f0f19;
      font-size:12px;
      opacity:.9;
      white-space:nowrap;
    }

    .badge.warn{
      background:var(--warnBg);
      border-color:var(--warnBorder);
      color:var(--warnText);
      font-weight:700;
      letter-spacing:.2px;
    }

    .badge.short{
      background:var(--shortBg);
      border-color:var(--shortBorder);
      color:var(--shortText);
      font-weight:700;
      letter-spacing:.2px;
    }

    .badge.small{ opacity:.75; }

    .timeline{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .monthRow{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
      min-height: 18px;
    }
    .monthTag{
      font-size:12px;
      color: var(--muted2);
      border:1px solid rgba(43,43,73,.65);
      background: rgba(15,15,25,.55);
      padding:2px 8px;
      border-radius:999px;
    }

    .beads{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
    }

    .bead{
      width:34px;
      height:34px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:650;
      letter-spacing:.2px;
      background:var(--bead);
      border:1px solid var(--beadBorder);
      color: var(--text);
      position:relative;
    }
    .bead.dim{
      opacity:.35;
      background: rgba(15,15,25,.6);
    }
    .bead.today{
      background: var(--todayBg);
      border-color: var(--todayBorder);
      box-shadow: 0 0 0 2px rgba(107,184,255,.12);
    }

    .bead:hover{
      border-color: rgba(154,209,255,.65);
      transform: translateY(-1px);
      transition: transform .08s ease;
    }

    .footerRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
      font-size:12px;
      color: var(--muted2);
      flex-wrap:wrap;
    }

    .error{
      padding:14px;
      border-radius:12px;
      background:var(--warnBg);
      border:1px solid var(--warnBorder);
      color:var(--warnText);
      white-space:pre-wrap;
      box-shadow: var(--shadow);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Kalispell Showtimes</h1>
    <div class="sub">
      Each bead is an actual listed date (not a filled-in range). Minimal color unless something is about to disappear.
    </div>

    <div class="controls">
      <label for="days">Days ahead</label>
      <input id="days" type="number" min="1" max="365" value="60" />

      <button class="btn primary" id="refresh">Refresh</button>
      <button class="btn" id="debug">Debug fetch</button>

      <span style="flex:1"></span>

      <button class="btn sort active" data-sort="now">Now</button>
      <button class="btn sort" data-sort="soon">Soon</button>
      <button class="btn sort" data-sort="long">Long runs</button>
      <button class="btn sort" data-sort="one">One night</button>
      <button class="btn sort" data-sort="az">A Z</button>

      <label class="toggle" title="Show only titles ending within 3 days">
        <input id="onlySoon" type="checkbox" />
        only leaving soon
      </label>
    </div>

    <div id="meta" class="meta"></div>
    <div id="out"></div>
  </div>

  <script>
    const out = document.getElementById("out");
    const meta = document.getElementById("meta");
    const daysEl = document.getElementById("days");
    const onlySoonEl = document.getElementById("onlySoon");

    const sortButtons = Array.from(document.querySelectorAll(".btn.sort"));
    let state = {
      sort: "now",
      movies: [],
      generated_at: null,
      source: null,
      days_ahead: 60
    };

    function parseISODate(s){
      const [y,m,d] = s.split("-").map(Number);
      return new Date(y, m-1, d);
    }

    function daysBetween(a, b){
      const ms = 24*60*60*1000;
      const ua = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
      const ub = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());
      return Math.round((ub - ua)/ms);
    }

    function formatMonthTag(d){
      const mon = d.toLocaleString(undefined, { month: "short" });
      return `${mon} ${d.getFullYear()}`;
    }

    function escapeHtml(s) {
      return (s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function setSort(newSort){
      state.sort = newSort;
      sortButtons.forEach(b => b.classList.toggle("active", b.dataset.sort === newSort));
      render();
    }

    sortButtons.forEach(btn => btn.addEventListener("click", () => setSort(btn.dataset.sort)));
    onlySoonEl.addEventListener("change", render);

    async function load(){
      const days = Math.max(1, Math.min(365, parseInt(daysEl.value || "60", 10)));
      daysEl.value = String(days);

      out.innerHTML = "";
      meta.textContent = "Loading…";

      try{
        const res = await fetch(`/api/showtimes?days=${days}`, { cache: "no-store" });
        const data = await res.json();

        if(!res.ok || data.error){
          meta.textContent = "";
          out.innerHTML = `<div class="error">${escapeHtml("Error: " + (data.error || res.statusText) + "\\n\\nDebug:\\n" + JSON.stringify(data.debug || {}, null, 2))}</div>`;
          return;
        }

        state.movies = data.movies || [];
        state.generated_at = data.generated_at;
        state.source = data.source;
        state.days_ahead = data.days_ahead;

        render();
      }catch(e){
        meta.textContent = "";
        out.innerHTML = `<div class="error">${escapeHtml("Request failed: " + e)}</div>`;
      }
    }

    async function debugFetch(){
      out.innerHTML = "";
      meta.textContent = "Running debug…";
      try{
        const res = await fetch(`/api/debug_raw`, { cache: "no-store" });
        const data = await res.json();
        meta.textContent = "";
        out.innerHTML = `<div class="error">${escapeHtml(JSON.stringify(data, null, 2))}</div>`;
      }catch(e){
        meta.textContent = "";
        out.innerHTML = `<div class="error">${escapeHtml("Debug failed: " + e)}</div>`;
      }
    }

    document.getElementById("refresh").addEventListener("click", load);
    document.getElementById("debug").addEventListener("click", debugFetch);

    function hasDates(movie){
      return Array.isArray(movie.dates) && movie.dates.length > 0;
    }

    function lastListedDate(movie){
      if(hasDates(movie)){
        return parseISODate(movie.dates[movie.dates.length - 1]);
      }
      return parseISODate(movie.last_date);
    }

    function leavingSoon(movie, today){
      const last = lastListedDate(movie);
      const daysLeft = daysBetween(today, last);
      return daysLeft <= 3;
    }

    function shortRun(movie){
      const n = hasDates(movie) ? movie.dates.length : (movie.run_length_days || 0);
      return n <= 3;
    }

    function sortMovies(movies){
      const list = movies.slice();

      if(state.sort === "az"){
        list.sort((a,b) => (a.title || "").localeCompare(b.title || ""));
        return list;
      }

      if(state.sort === "one"){
        list.sort((a,b) => (a.run_length_days - b.run_length_days) || (a.days_until_start - b.days_until_start) || (a.title||"").localeCompare(b.title||""));
        return list;
      }

      if(state.sort === "long"){
        list.sort((a,b) => (b.run_length_days - a.run_length_days) || (a.days_until_start - b.days_until_start) || (a.title||"").localeCompare(b.title||""));
        return list;
      }

      if(state.sort === "soon"){
        list.sort((a,b) => {
          const af = a.days_until_start;
          const bf = b.days_until_start;
          const aKey = (af < 0) ? 9999 : af;
          const bKey = (bf < 0) ? 9999 : bf;
          return (aKey - bKey) || (a.run_length_days - b.run_length_days) || (a.title||"").localeCompare(b.title||"");
        });
        return list;
      }

      // default "now"
      list.sort((a,b) => {
        const aNow = a.days_until_start <= 0 ? 0 : 1;
        const bNow = b.days_until_start <= 0 ? 0 : 1;
        return (aNow - bNow) ||
               (a.days_until_start - b.days_until_start) ||
               (a.run_length_days - b.run_length_days) ||
               (a.title||"").localeCompare(b.title||"");
      });
      return list;
    }

    function buildBeadsFromDates(movie, today){
      const dates = hasDates(movie) ? movie.dates : [];
      const beads = [];
      const monthTags = [];
      let lastMonthKey = null;

      for(const iso of dates){
        const dt = parseISODate(iso);
        const y = dt.getFullYear();
        const m = dt.getMonth();
        const d = dt.getDate();

        const isToday = (y === today.getFullYear() && m === today.getMonth() && d === today.getDate());
        const isPast = (daysBetween(dt, today) < 0);

        const monthKey = `${y}-${m}`;
        if(monthKey !== lastMonthKey){
          monthTags.push(formatMonthTag(dt));
          lastMonthKey = monthKey;
        }

        beads.push({
          label: String(d),
          title: dt.toLocaleString(undefined, { month: "short", day: "numeric", year: "numeric", weekday: "short" }),
          cls: "bead" + (isPast ? " dim" : (isToday ? " today" : ""))
        });
      }

      return { beads, monthTags, totalDays: dates.length };
    }

    function cardHTML(movie){
      const today = new Date();

      const soon = leavingSoon(movie, today);
      const onlySoon = onlySoonEl.checked;
      if(onlySoon && !soon) return "";

      const startsIn = movie.days_until_start;

      let startText = "";
      if(startsIn === 0) startText = "starts today";
      else if(startsIn === 1) startText = "starts tomorrow";
      else if(startsIn > 1) startText = `starts in ${startsIn} days`;
      else startText = `already started`;

      const last = lastListedDate(movie);
      const daysLeft = daysBetween(today, last);

      let endText = "";
      if(daysLeft === 0) endText = "ends today";
      else if(daysLeft === 1) endText = "ends tomorrow";
      else if(daysLeft > 1) endText = `ends in ${daysLeft} days`;
      else endText = `ended ${Math.abs(daysLeft)} days ago`;

      const { beads, monthTags, totalDays } = buildBeadsFromDates(movie, today);

      // Month tags: show up to 2, then +N
      let monthRow = "";
      if(monthTags.length){
        const shown = monthTags.slice(0,2).map(t => `<span class="monthTag">${escapeHtml(t)}</span>`).join("");
        const more = monthTags.length > 2 ? `<span class="monthTag">+${monthTags.length-2}</span>` : "";
        monthRow = `<div class="monthRow">${shown}${more}</div>`;
      }

      const beadsHTML = beads.map(b => `<div class="${b.cls}" title="${escapeHtml(b.title)}">${escapeHtml(b.label)}</div>`).join("");

      const badgeSoon = soon ? `<span class="badge warn">LEAVING SOON</span>` : "";
      const badgeShort = shortRun(movie) ? `<span class="badge short">SHORT RUN</span>` : "";
      const badgeRun = `<span class="badge small">${totalDays} day${totalDays===1?"":"s"}</span>`;

      return `
        <div class="card">
          <div class="titleRow">
            <h2 class="title">${escapeHtml(movie.title)}</h2>
            <div class="badges">
              ${badgeSoon}
              ${badgeShort}
              ${badgeRun}
            </div>
          </div>

          <div class="timeline">
            ${monthRow}
            <div class="beads">${beadsHTML}</div>
          </div>

          <div class="footerRow">
            <span>${escapeHtml(startText)}</span>
            <span>${escapeHtml(endText)}</span>
          </div>
        </div>
      `;
    }

    function render(){
      const movies = sortMovies(state.movies);

      meta.textContent = `Generated: ${state.generated_at}   Source: ${state.source}   Days ahead: ${state.days_ahead}`;

      const htmlCards = movies.map(cardHTML).filter(Boolean).join("");

      if(!htmlCards){
        out.innerHTML = `<div class="error">Nothing to show with current filters. Try turning off “only leaving soon”.</div>`;
        return;
      }

      out.innerHTML = `<div class="grid">${htmlCards}</div>`;
    }

    load();
  </script>
</body>
</html>
