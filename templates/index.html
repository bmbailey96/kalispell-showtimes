<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalispell Showtimes</title>
  <style>
    :root{
      --bg:#0b0b0f;
      --panel:#10101a;
      --panel2:#141421;
      --border:#23233a;
      --text:#eaeaf2;
      --muted:rgba(234,234,242,.72);
      --muted2:rgba(234,234,242,.55);
      --accent:#9ad1ff;

      --bead:#161625;
      --beadBorder:#2b2b49;
      --beadDim:#0f0f19;

      --shadow: 0 8px 24px rgba(0,0,0,.35);

      --warnBg:#2a0f16;
      --warnBorder:#5a1b2a;
      --warnText:#ffd6de;

      --shortBg:#1a1a12;
      --shortBorder:#4b4420;
      --shortText:#fff1b8;

      --eventBg:#0f1a16;
      --eventBorder:#1f4b3b;
      --eventText:#bfffe7;

      --oneBg:#101a2b;
      --oneBorder:#274a7a;
      --oneText:#cfe6ff;

      --todayBg:#1d2a3a;
      --todayBorder:#6bb8ff;

      --sectionBg: rgba(20,20,33,.7);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:24px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{ max-width:1240px; margin:0 auto; }
    h1{ margin:0 0 10px; font-size:26px; letter-spacing:.2px; }
    .sub{ opacity:.8; margin-bottom:18px; max-width: 95ch; }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin:16px 0 10px;
      padding:14px;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow: var(--shadow);
    }

    label{ opacity:.85; font-size:13px; }

    input[type="number"]{
      width:92px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--beadBorder);
      background:var(--beadDim);
      color:var(--text);
      outline:none;
    }

    .search{
      width: 220px;
      max-width: 48vw;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--beadBorder);
      background:var(--beadDim);
      color:var(--text);
      outline:none;
    }

    .btn{
      padding:9px 12px;
      border-radius:10px;
      border:1px solid var(--beadBorder);
      background:#1c1c2e;
      color:var(--text);
      cursor:pointer;
      user-select:none;
      font-size:13px;
      line-height:1;
      white-space:nowrap;
    }
    .btn:hover{ background:#23233a; }

    .btn.primary{
      border-color: rgba(154,209,255,.6);
      background: rgba(154,209,255,.10);
    }

    .btn.sort{ background:#161625; }
    .btn.sort.active{
      border-color: rgba(154,209,255,.7);
      background: rgba(154,209,255,.14);
    }

    .toggle{
      display:flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--beadBorder);
      background:#161625;
      cursor:pointer;
      font-size:13px;
      user-select:none;
      white-space:nowrap;
    }
    .toggle input{ accent-color: var(--accent); }

    .meta{
      font-size:13px;
      opacity:.75;
      margin:10px 0 18px;
      white-space:pre-wrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 900px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .section{
      margin: 18px 0 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--sectionBg);
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      box-shadow: var(--shadow);
    }
    .sectionTitle{
      margin:0;
      font-size: 14px;
      font-weight: 800;
      letter-spacing: .4px;
      text-transform: uppercase;
      opacity: .92;
    }
    .sectionHint{
      font-size: 12px;
      color: var(--muted2);
      white-space: nowrap;
    }

    .card{
      padding:14px 14px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--panel);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }

    .cardRow{
      display:flex;
      gap:12px;
      align-items:flex-start;
    }

    .posterWrap{
      width: 62px;
      min-width: 62px;
      height: 92px;
      border-radius: 10px;
      overflow:hidden;
      border: 1px solid rgba(43,43,73,.7);
      background: rgba(15,15,25,.55);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .poster{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      opacity: 0;
      transition: opacity .2s ease;
    }
    .poster.loaded{ opacity: 1; }
    .posterPh{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(234,234,242,.25);
      font-weight: 900;
      letter-spacing: .6px;
      font-size: 10px;
      text-transform: uppercase;
      user-select:none;
    }

    .content{ flex:1; min-width:0; }

    .titleRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }

    .title{
      font-size:16px;
      font-weight:800;
      line-height:1.15;
      margin:0;
    }

    .badges{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      max-width: 62%;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--beadBorder);
      background:#0f0f19;
      font-size:12px;
      opacity:.92;
      white-space:nowrap;
      font-weight:650;
      letter-spacing:.15px;
    }

    .badge.warn{ background:var(--warnBg); border-color:var(--warnBorder); color:var(--warnText); }
    .badge.short{ background:var(--shortBg); border-color:var(--shortBorder); color:var(--shortText); }
    .badge.event{ background:var(--eventBg); border-color:var(--eventBorder); color:var(--eventText); }
    .badge.one{ background:var(--oneBg); border-color:var(--oneBorder); color:var(--oneText); }
    .badge.small{ opacity:.75; font-weight:600; }

    .planRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 6px 0 10px;
      flex-wrap:wrap;
    }
    .planLine{
      font-size: 13px;
      color: var(--muted);
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .planLabel{ color: var(--muted2); }
    .planValue{ font-weight: 800; color: var(--text); }

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .smallBtn{
      border: 1px solid rgba(43,43,73,.8);
      background: rgba(15,15,25,.55);
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      line-height: 1;
      white-space:nowrap;
    }
    .smallBtn:hover{
      border-color: rgba(154,209,255,.5);
      color: var(--text);
    }

    .timeline{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .monthRow{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
      min-height: 18px;
    }
    .monthTag{
      font-size:12px;
      color: var(--muted2);
      border:1px solid rgba(43,43,73,.65);
      background: rgba(15,15,25,.55);
      padding:2px 8px;
      border-radius:999px;
    }

    .beads{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
    }

    .bead{
      width:34px;
      height:34px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:800;
      letter-spacing:.2px;
      background:var(--bead);
      border:1px solid var(--beadBorder);
      color: var(--text);
    }
    .bead.dim{ opacity:.35; background: rgba(15,15,25,.6); }
    .bead.today{
      background: var(--todayBg);
      border-color: var(--todayBorder);
      box-shadow: 0 0 0 2px rgba(107,184,255,.12);
    }
    .gapDots{
      width: 22px;
      height: 34px;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(234,234,242,.22);
      font-weight: 900;
      letter-spacing: 2px;
      user-select:none;
    }

    .footerRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
      font-size:12px;
      color: var(--muted2);
      flex-wrap:wrap;
    }

    /* MUTED: hard collapse */
    .mutedCard{
      padding: 10px 12px;
      opacity: .35;
      filter: saturate(.55);
    }
    .mutedCard .cardRow,
    .mutedCard .posterWrap,
    .mutedCard .badges,
    .mutedCard .planRow,
    .mutedCard .timeline,
    .mutedCard .footerRow{
      display:none !important;
    }
    .mutedCard .muteRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .mutedCard .title{
      font-size: 14px;
      font-weight: 800;
      margin:0;
    }
    .mutedCard .muteActions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .error{
      padding:14px;
      border-radius:12px;
      background:var(--warnBg);
      border:1px solid var(--warnBorder);
      color:var(--warnText);
      white-space:pre-wrap;
      box-shadow: var(--shadow);
    }

    /* ---------- CALENDAR MODE ---------- */
    .calTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 12px 0 10px;
      flex-wrap:wrap;
    }
    .calTitle{
      font-size: 16px;
      font-weight: 900;
      letter-spacing:.2px;
      opacity:.95;
    }
    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:10px;
    }
    .calDay{
      border:1px solid var(--border);
      background: rgba(16,16,26,.85);
      border-radius:12px;
      padding:10px;
      min-height: 140px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .calHead{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .calDow{
      font-size: 12px;
      color: var(--muted2);
      font-weight: 800;
      letter-spacing:.4px;
      text-transform: uppercase;
    }
    .calNum{
      font-size: 13px;
      font-weight: 900;
      opacity:.95;
    }
    .calNum.today{
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(107,184,255,.65);
      background: rgba(107,184,255,.12);
    }
    .calList{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .chip{
      border:1px solid rgba(43,43,73,.75);
      background: rgba(15,15,25,.55);
      border-radius: 10px;
      padding: 6px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      cursor: default;
    }
    .chipTitle{
      font-size: 12px;
      font-weight: 800;
      line-height: 1.1;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .chipDot{
      width:8px;
      height:8px;
      border-radius:999px;
      background: rgba(234,234,242,.25);
      flex: 0 0 auto;
    }
    .chipDot.soon{ background: #ff6b86; box-shadow: 0 0 0 2px rgba(255,107,134,.15); }
    .chipDot.muted{ background: rgba(234,234,242,.18); }
    .chip.muted{
      opacity:.35;
      filter:saturate(.55);
    }
    .chipRowBtns{
      display:flex;
      gap:6px;
      flex: 0 0 auto;
    }
    .chipBtn{
      border:1px solid rgba(43,43,73,.75);
      background: rgba(15,15,25,.55);
      color: var(--muted2);
      border-radius: 9px;
      padding: 4px 7px;
      font-size: 11px;
      cursor:pointer;
      user-select:none;
    }
    .chipBtn:hover{
      border-color: rgba(154,209,255,.5);
      color: var(--text);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Kalispell Showtimes</h1>
    <div class="sub">
      Calendar mode is date based (not showtime times yet). If you want the full “4:45p” calendar later, we’ll upgrade the scraper.
    </div>

    <div class="controls">
      <label for="days">Days ahead</label>
      <input id="days" type="number" min="1" max="365" value="60" />

      <button class="btn primary" id="refresh">Refresh</button>
      <button class="btn" id="debug">Debug fetch</button>

      <input id="q" class="search" placeholder="search titles…" />

      <label class="toggle" title="Group into Now / Next 7 Days / Later / One Night">
        <input id="grouped" type="checkbox" checked />
        grouped
      </label>

      <label class="toggle" title="Show only titles ending within 3 days">
        <input id="onlySoon" type="checkbox" />
        only leaving soon
      </label>

      <label class="toggle" title="When enabled, muted titles render at the bottom of each section">
        <input id="mutedBottom" type="checkbox" checked />
        muted to bottom
      </label>

      <span style="flex:1"></span>

      <button class="btn sort active" data-sort="plan">Plan</button>
      <button class="btn sort" data-sort="az">A Z</button>
      <button class="btn sort" data-sort="long">Long</button>
      <button class="btn sort" data-sort="short">Short</button>

      <button class="btn sort active" id="viewList">List</button>
      <button class="btn sort" id="viewCal">Calendar</button>
    </div>

    <div id="meta" class="meta"></div>
    <div id="out"></div>
  </div>

  <script>
    const out = document.getElementById("out");
    const meta = document.getElementById("meta");
    const daysEl = document.getElementById("days");
    const onlySoonEl = document.getElementById("onlySoon");
    const groupedEl = document.getElementById("grouped");
    const mutedBottomEl = document.getElementById("mutedBottom");
    const qEl = document.getElementById("q");

    const sortButtons = Array.from(document.querySelectorAll(".btn.sort")).filter(b => b.dataset.sort);
    const viewListBtn = document.getElementById("viewList");
    const viewCalBtn  = document.getElementById("viewCal");

    // ---------- persistence ----------
    const HIDDEN_KEY = "kalispell_hidden_titles_v4";
    const MUTED_KEY  = "kalispell_muted_titles_v4";

    function loadSet(key){
      try{
        const raw = localStorage.getItem(key);
        const arr = raw ? JSON.parse(raw) : [];
        return new Set(Array.isArray(arr) ? arr : []);
      }catch{
        return new Set();
      }
    }
    function saveSet(key, set){
      localStorage.setItem(key, JSON.stringify(Array.from(set)));
    }

    let hiddenSet = loadSet(HIDDEN_KEY);
    let mutedSet  = loadSet(MUTED_KEY);

    function hideTitle(title){
      hiddenSet.add(title);
      saveSet(HIDDEN_KEY, hiddenSet);
      render();
    }
    function toggleMute(title){
      if(mutedSet.has(title)) mutedSet.delete(title);
      else mutedSet.add(title);
      saveSet(MUTED_KEY, mutedSet);
      render();
    }

    // ---------- helpers ----------
    function escapeHtml(s) {
      return (s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }
    function escapeAttr(s){
      return (s || "")
        .replaceAll("&","&amp;")
        .replaceAll('"',"&quot;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function parseISODate(s){
      const [y,m,d] = s.split("-").map(Number);
      return new Date(y, m-1, d);
    }

    function dateKey(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }

    function daysBetween(a, b){
      const ms = 24*60*60*1000;
      const ua = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
      const ub = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());
      return Math.round((ub - ua)/ms);
    }

    function formatMonthTag(d){
      const mon = d.toLocaleString(undefined, { month: "short" });
      return `${mon} ${d.getFullYear()}`;
    }

    function formatNextLabel(dt, today){
      const diff = daysBetween(today, dt);
      const w = dt.toLocaleString(undefined, { weekday: "short" });
      const mon = dt.toLocaleString(undefined, { month: "short" });
      const day = dt.getDate();
      if(diff === 0) return `Today (${w})`;
      if(diff === 1) return `Tomorrow (${w})`;
      if(diff > 1 && diff <= 7) return `${w} (${mon} ${day})`;
      return `${mon} ${day} (${w})`;
    }

    // ---------- poster fetching ----------
    const posterCache = new Map(); // title -> poster_url|null
    async function fetchPoster(title){
      if(posterCache.has(title)) return posterCache.get(title);
      try{
        const res = await fetch(`/api/poster?title=${encodeURIComponent(title)}`, { cache: "no-store" });
        const data = await res.json();
        const url = (data && data.ok) ? data.poster_url : null;
        posterCache.set(title, url);
        return url;
      }catch{
        posterCache.set(title, null);
        return null;
      }
    }

    async function hydratePosters(){
      if(state.view !== "list") return;

      const imgs = Array.from(document.querySelectorAll("img.poster[data-title]"));
      const queue = imgs.slice();
      const concurrency = 4;
      let active = 0;

      return new Promise((resolve)=>{
        const tick = async () => {
          while(active < concurrency && queue.length){
            const img = queue.shift();
            active++;

            const title = img.getAttribute("data-title");
            const ph = img.previousElementSibling;

            fetchPoster(title).then((url)=>{
              if(url){
                img.src = url;
                img.onload = () => img.classList.add("loaded");
                if(ph) ph.style.display = "none";
              }
            }).finally(()=>{
              active--;
              if(queue.length === 0 && active === 0) resolve();
              else tick();
            });
          }
        };
        tick();
      });
    }

    // ---------- planner logic ----------
    function hasDates(movie){
      return Array.isArray(movie.dates) && movie.dates.length > 0;
    }

    function sortedDateObjs(movie){
      const arr = hasDates(movie) ? movie.dates.slice() : [];
      arr.sort();
      return arr.map(parseISODate);
    }

    function getNextShowing(movie, today){
      const dates = sortedDateObjs(movie);
      for(const d of dates){
        if(daysBetween(today, d) >= 0) return d;
      }
      return null;
    }

    function getLastShowing(movie){
      const dates = sortedDateObjs(movie);
      return dates.length ? dates[dates.length - 1] : null;
    }

    function leavingSoon(movie, today){
      const last = getLastShowing(movie);
      if(!last) return false;
      return daysBetween(today, last) <= 3;
    }

    function runCount(movie){
      return hasDates(movie) ? movie.dates.length : (movie.run_length_days || 0);
    }

    function spanDays(movie){
      const dates = sortedDateObjs(movie);
      if(dates.length <= 1) return 0;
      return daysBetween(dates[0], dates[dates.length - 1]);
    }

    function classify(movie){
      const n = runCount(movie);
      const span = spanDays(movie);
      if(n === 1) return "one";
      if(n <= 3 && span >= 4) return "event";
      if(n <= 3 && span <= 3) return "short";
      return "normal";
    }

    function buildBeads(movie, today){
      const dates = sortedDateObjs(movie);
      const beads = [];
      const monthTags = [];

      let lastMonthKey = null;
      let prev = null;

      for(const dt of dates){
        if(prev){
          const gap = daysBetween(prev, dt);
          if(gap > 1) beads.push({ gap: true });
        }
        prev = dt;

        const y = dt.getFullYear();
        const m = dt.getMonth();
        const d = dt.getDate();

        const isToday = (y === today.getFullYear() && m === today.getMonth() && d === today.getDate());
        const isPast = (daysBetween(dt, today) < 0);

        const monthKey = `${y}-${m}`;
        if(monthKey !== lastMonthKey){
          monthTags.push(formatMonthTag(dt));
          lastMonthKey = monthKey;
        }

        beads.push({
          label: String(d),
          title: dt.toLocaleString(undefined, { month: "short", day: "numeric", year: "numeric", weekday: "short" }),
          cls: "bead" + (isPast ? " dim" : (isToday ? " today" : ""))
        });
      }

      return { beads, monthTags };
    }

    function matchesSearch(movie){
      const q = (qEl.value || "").trim().toLowerCase();
      if(!q) return true;
      return (movie.title || "").toLowerCase().includes(q);
    }

    function moviePassesFilters(movie, today){
      if(hiddenSet.has(movie.title)) return false;
      if(onlySoonEl.checked && !leavingSoon(movie, today)) return false;
      if(!matchesSearch(movie)) return false;
      return true;
    }

    function nextDiff(movie, today){
      const nx = getNextShowing(movie, today);
      if(!nx) return 9999;
      return daysBetween(today, nx);
    }

    function sortList(list, today){
      const arr = list.slice();

      if(state.sort === "az"){
        arr.sort((a,b) => (a.title||"").localeCompare(b.title||""));
      } else if(state.sort === "long"){
        arr.sort((a,b) => (runCount(b) - runCount(a)) || (nextDiff(a,today) - nextDiff(b,today)) || (a.title||"").localeCompare(b.title||""));
      } else if(state.sort === "short"){
        arr.sort((a,b) => (runCount(a) - runCount(b)) || (nextDiff(a,today) - nextDiff(b,today)) || (a.title||"").localeCompare(b.title||""));
      } else {
        // plan
        arr.sort((a,b) => {
          const ad = nextDiff(a,today);
          const bd = nextDiff(b,today);
          const aSoon = leavingSoon(a,today) ? 0 : 1;
          const bSoon = leavingSoon(b,today) ? 0 : 1;
          return (ad - bd) || (aSoon - bSoon) || (runCount(a) - runCount(b)) || (a.title||"").localeCompare(b.title||"");
        });
      }

      if(mutedBottomEl.checked){
        const unmuted = arr.filter(m => !mutedSet.has(m.title));
        const muted = arr.filter(m => mutedSet.has(m.title));
        return unmuted.concat(muted);
      }
      return arr;
    }

    function groupMovies(movies, today){
      const groups = { now: [], next7: [], later: [], one: [] };

      for(const m of movies){
        if(!moviePassesFilters(m, today)) continue;

        const next = getNextShowing(m, today);
        const last = getLastShowing(m);
        if(!next || !last) continue;

        const dNext = daysBetween(today, next);
        const isOne = (runCount(m) === 1);

        if(isOne) groups.one.push(m);
        else if(dNext <= 0) groups.now.push(m);
        else if(dNext <= 7) groups.next7.push(m);
        else groups.later.push(m);
      }

      groups.now = sortList(groups.now, today);
      groups.next7 = sortList(groups.next7, today);
      groups.later = sortList(groups.later, today);
      groups.one = sortList(groups.one, today);

      return groups;
    }

    function badgeHTML(movie, today){
      const n = runCount(movie);
      const kind = classify(movie);
      const soon = leavingSoon(movie, today);

      const parts = [];
      if(soon) parts.push(`<span class="badge warn">LEAVING SOON</span>`);
      if(kind === "one") parts.push(`<span class="badge one">ONE NIGHT</span>`);
      else if(kind === "event") parts.push(`<span class="badge event">EVENT DATES</span>`);
      else if(kind === "short") parts.push(`<span class="badge short">SHORT RUN</span>`);
      parts.push(`<span class="badge small">${n} day${n===1?"":"s"}</span>`);
      return parts.join("");
    }

    function posterHTML(title){
      const safe = escapeAttr(title);
      return `
        <div class="posterWrap">
          <div class="posterPh">poster</div>
          <img class="poster" data-title="${safe}" alt="Poster for ${safe}" />
        </div>
      `;
    }

    function mutedCardHTML(title){
      return `
        <div class="card mutedCard">
          <div class="muteRow">
            <h2 class="title">${escapeHtml(title)}</h2>
            <div class="muteActions">
              <button class="smallBtn" data-mute="${escapeAttr(title)}">unmute</button>
              <button class="smallBtn" data-hide="${escapeAttr(title)}">hide</button>
            </div>
          </div>
        </div>
      `;
    }

    function cardHTML(movie, today){
      const title = movie.title || "Untitled";

      if(mutedSet.has(title)){
        return mutedCardHTML(title);
      }

      const next = getNextShowing(movie, today);
      const last = getLastShowing(movie);
      if(!next || !last) return "";

      const nextLabel = formatNextLabel(next, today);

      const endsIn = daysBetween(today, last);
      let endText = "";
      if(endsIn === 0) endText = "ends today";
      else if(endsIn === 1) endText = "ends tomorrow";
      else if(endsIn > 1) endText = `ends in ${endsIn} days`;
      else endText = `ended`;

      const { beads, monthTags } = buildBeads(movie, today);

      let monthRow = "";
      if(monthTags.length){
        const shown = monthTags.slice(0,2).map(t => `<span class="monthTag">${escapeHtml(t)}</span>`).join("");
        const more = monthTags.length > 2 ? `<span class="monthTag">+${monthTags.length-2}</span>` : "";
        monthRow = `<div class="monthRow">${shown}${more}</div>`;
      }

      const beadsHTML = beads.map(b => {
        if(b.gap) return `<div class="gapDots" title="gap">···</div>`;
        return `<div class="${b.cls}" title="${escapeHtml(b.title)}">${escapeHtml(b.label)}</div>`;
      }).join("");

      return `
        <div class="card">
          <div class="cardRow">
            ${posterHTML(title)}
            <div class="content">
              <div class="titleRow">
                <h2 class="title">${escapeHtml(title)}</h2>
                <div class="badges">
                  ${badgeHTML(movie, today)}
                </div>
              </div>

              <div class="planRow">
                <div class="planLine">
                  <span class="planLabel">Next showing</span>
                  <span class="planValue">${escapeHtml(nextLabel)}</span>
                  <span class="planLabel">·</span>
                  <span class="planLabel">${escapeHtml(endText)}</span>
                </div>

                <div class="actions">
                  <button class="smallBtn" data-mute="${escapeAttr(title)}" title="Collapse this title">mute</button>
                  <button class="smallBtn" data-hide="${escapeAttr(title)}" title="Hide this title">hide</button>
                </div>
              </div>

              <div class="timeline">
                ${monthRow}
                <div class="beads">${beadsHTML}</div>
              </div>

              <div class="footerRow">
                <span>first listed: ${escapeHtml(movie.first_date)}</span>
                <span>last listed: ${escapeHtml(movie.last_date)}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function attachHandlers(){
      document.querySelectorAll("button[data-hide]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const title = btn.getAttribute("data-hide");
          hideTitle(title);
        });
      });
      document.querySelectorAll("button[data-mute]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const title = btn.getAttribute("data-mute");
          toggleMute(title);
        });
      });
    }

    // ---------- sort / view controls ----------
    let state = {
      sort: "plan",
      view: "list",
      movies: [],
      generated_at: null,
      source: null,
      days_ahead: 60,
      calWeekStart: null
    };

    function setSort(newSort){
      state.sort = newSort;
      sortButtons.forEach(b => b.classList.toggle("active", b.dataset.sort === newSort));
      render();
    }
    sortButtons.forEach(btn => btn.addEventListener("click", () => setSort(btn.dataset.sort)));

    function setView(v){
      state.view = v;
      viewListBtn.classList.toggle("active", v === "list");
      viewCalBtn.classList.toggle("active", v === "cal");
      render();
    }
    viewListBtn.addEventListener("click", ()=> setView("list"));
    viewCalBtn.addEventListener("click", ()=> setView("cal"));

    // ---------- data ----------
    async function load(){
      const days = Math.max(1, Math.min(365, parseInt(daysEl.value || "60", 10)));
      daysEl.value = String(days);

      out.innerHTML = "";
      meta.textContent = "Loading…";

      try{
        const res = await fetch(`/api/showtimes?days=${days}`, { cache: "no-store" });
        const data = await res.json();

        if(!res.ok || data.error){
          meta.textContent = "";
          out.innerHTML = `<div class="error">${escapeHtml("Error: " + (data.error || res.statusText) + "\\n\\nDebug:\\n" + JSON.stringify(data.debug || {}, null, 2))}</div>`;
          return;
        }

        state.movies = data.movies || [];
        state.generated_at = data.generated_at;
        state.source = data.source;
        state.days_ahead = data.days_ahead;

        // init calendar week start to current week (Sunday)
        if(!state.calWeekStart){
          const t = new Date();
          const start = new Date(t.getFullYear(), t.getMonth(), t.getDate());
          start.setDate(start.getDate() - start.getDay());
          state.calWeekStart = start;
        }

        render();
      }catch(e){
        meta.textContent = "";
        out.innerHTML = `<div class="error">${escapeHtml("Request failed: " + e)}</div>`;
      }
    }

    async function debugFetch(){
      out.innerHTML = "";
      meta.textContent = "Running debug…";
      try{
        const res = await fetch(`/api/debug_raw`, { cache: "no-store" });
        const data = await res.json();
        meta.textContent = "";
        out.innerHTML = `<div class="error">${escapeHtml(JSON.stringify(data, null, 2))}</div>`;
      }catch(e){
        meta.textContent = "";
        out.innerHTML = `<div class="error">${escapeHtml("Debug failed: " + e)}</div>`;
      }
    }

    document.getElementById("refresh").addEventListener("click", load);
    document.getElementById("debug").addEventListener("click", debugFetch);
    onlySoonEl.addEventListener("change", render);
    groupedEl.addEventListener("change", render);
    mutedBottomEl.addEventListener("change", render);
    qEl.addEventListener("input", render);

    function renderCards(movies, today){
      const html = movies.map(m => cardHTML(m, today)).filter(Boolean).join("");
      if(!html) return "";
      return `<div class="grid">${html}</div>`;
    }

    function renderList(){
      const today = new Date();
      const filtered = state.movies.filter(m => moviePassesFilters(m, today));
      if(filtered.length === 0){
        out.innerHTML = `<div class="error">Nothing to show. Either everything is hidden, or your filters/search are too spicy.</div>`;
        return;
      }

      if(groupedEl.checked){
        const g = groupMovies(state.movies, today);
        const blocks = [];

        if(g.now.length){
          blocks.push(`
            <div class="section">
              <h2 class="sectionTitle">Now playing</h2>
              <div class="sectionHint">${g.now.length} title${g.now.length===1?"":"s"}</div>
            </div>
            ${renderCards(g.now, today)}
          `);
        }

        if(g.next7.length){
          blocks.push(`
            <div class="section">
              <h2 class="sectionTitle">Next 7 days</h2>
              <div class="sectionHint">${g.next7.length} title${g.next7.length===1?"":"s"}</div>
            </div>
            ${renderCards(g.next7, today)}
          `);
        }

        if(g.later.length){
          blocks.push(`
            <div class="section">
              <h2 class="sectionTitle">Later</h2>
              <div class="sectionHint">${g.later.length} title${g.later.length===1?"":"s"}</div>
            </div>
            ${renderCards(g.later, today)}
          `);
        }

        if(g.one.length){
          blocks.push(`
            <div class="section">
              <h2 class="sectionTitle">One night only</h2>
              <div class="sectionHint">${g.one.length} title${g.one.length===1?"":"s"}</div>
            </div>
            ${renderCards(g.one, today)}
          `);
        }

        out.innerHTML = blocks.join("") || `<div class="error">Nothing to show with current filters.</div>`;
      } else {
        out.innerHTML = renderCards(sortList(filtered, today), today);
      }

      attachHandlers();
      hydratePosters();
    }

    function calWeekRangeTitle(start){
      const end = new Date(start.getFullYear(), start.getMonth(), start.getDate());
      end.setDate(end.getDate() + 6);
      const opts = { month: "short", day: "numeric" };
      const a = start.toLocaleString(undefined, opts);
      const b = end.toLocaleString(undefined, opts);
      const y = end.getFullYear();
      return `${a} – ${b}, ${y}`;
    }

    function buildCalendarMap(today){
      // Map: dateKey -> array of movies on that date
      const map = new Map();

      for(const m of state.movies){
        if(!moviePassesFilters(m, today)) continue;
        if(!hasDates(m)) continue;

        for(const iso of m.dates){
          const dt = parseISODate(iso);
          const k = dateKey(dt);
          if(!map.has(k)) map.set(k, []);
          map.get(k).push(m);
        }
      }

      // Sort each day’s list with our same sort logic (plus muted-to-bottom behavior)
      for(const [k, arr] of map.entries()){
        map.set(k, sortList(arr, today));
      }
      return map;
    }

    function renderCalendar(){
      const today = new Date();
      const start = state.calWeekStart || (() => {
        const t = new Date();
        const s = new Date(t.getFullYear(), t.getMonth(), t.getDate());
        s.setDate(s.getDate() - s.getDay());
        return s;
      })();

      const map = buildCalendarMap(today);

      const dows = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
      const days = [];

      for(let i=0;i<7;i++){
        const dt = new Date(start.getFullYear(), start.getMonth(), start.getDate());
        dt.setDate(dt.getDate() + i);
        days.push(dt);
      }

      const top = `
        <div class="calTop">
          <div class="calTitle">${escapeHtml(calWeekRangeTitle(start))}</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn" id="calPrev">◀</button>
            <button class="btn" id="calToday">Today</button>
            <button class="btn" id="calNext">▶</button>
          </div>
        </div>
      `;

      const grid = `
        <div class="calGrid">
          ${days.map((dt, idx) => {
            const k = dateKey(dt);
            const list = map.get(k) || [];
            const isToday = (dateKey(dt) === dateKey(today));
            const numClass = isToday ? "calNum today" : "calNum";

            const items = list.slice(0, 10).map(m => {
              const title = m.title || "Untitled";
              const soon = leavingSoon(m, today);
              const isMuted = mutedSet.has(title);

              return `
                <div class="chip ${isMuted ? "muted" : ""}">
                  <div style="display:flex; align-items:center; gap:8px; min-width:0;">
                    <div class="chipDot ${soon ? "soon" : ""} ${isMuted ? "muted" : ""}" title="${soon ? "leaving soon" : ""}"></div>
                    <div class="chipTitle" title="${escapeAttr(title)}">${escapeHtml(title)}</div>
                  </div>
                  <div class="chipRowBtns">
                    <button class="chipBtn" data-mute="${escapeAttr(title)}">${isMuted ? "unmute" : "mute"}</button>
                    <button class="chipBtn" data-hide="${escapeAttr(title)}">hide</button>
                  </div>
                </div>
              `;
            }).join("");

            const more = list.length > 10 ? `<div style="margin-top:6px; font-size:12px; color: var(--muted2);">+${list.length-10} more</div>` : "";

            return `
              <div class="calDay">
                <div class="calHead">
                  <div class="calDow">${dows[idx]}</div>
                  <div class="${numClass}">${dt.toLocaleString(undefined, { month:"short", day:"numeric" })}</div>
                </div>
                <div class="calList">${items || `<div style="color: var(--muted2); font-size:12px;">nothing</div>`}</div>
                ${more}
              </div>
            `;
          }).join("")}
        </div>
      `;

      out.innerHTML = top + grid;

      // calendar nav buttons
      document.getElementById("calPrev").addEventListener("click", ()=>{
        const s = state.calWeekStart;
        const n = new Date(s.getFullYear(), s.getMonth(), s.getDate());
        n.setDate(n.getDate() - 7);
        state.calWeekStart = n;
        render();
      });
      document.getElementById("calNext").addEventListener("click", ()=>{
        const s = state.calWeekStart;
        const n = new Date(s.getFullYear(), s.getMonth(), s.getDate());
        n.setDate(n.getDate() + 7);
        state.calWeekStart = n;
        render();
      });
      document.getElementById("calToday").addEventListener("click", ()=>{
        const t = new Date();
        const s = new Date(t.getFullYear(), t.getMonth(), t.getDate());
        s.setDate(s.getDate() - s.getDay());
        state.calWeekStart = s;
        render();
      });

      attachHandlers();
    }

    function render(){
      meta.textContent = `Generated: ${state.generated_at}   Source: ${state.source}   Days ahead: ${state.days_ahead}`;
      if(state.view === "cal") renderCalendar();
      else renderList();
    }

    // init
    load();
  </script>
</body>
</html>
