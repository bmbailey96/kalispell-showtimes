<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Kalispell Showtimes</title>
  <style>
    :root{
      --bg:#07070b;
      --panel:#0f0f18;
      --panel2:#121222;
      --border:#22223a;
      --border2:#2b2b49;
      --text:#eaeaf2;
      --muted:#a7a7c2;
      --muted2:#8a8aa6;
      --accent:#7ec7ff;
      --good:#51d88a;
      --warn:#ffcc66;
      --bad:#ff6b7a;

      --pillbg:#0c0c16;
      --shadow: 0 10px 30px rgba(0,0,0,.55);
      --radius:14px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 30% 10%, rgba(110,90,255,.16), transparent 55%),
                  radial-gradient(900px 500px at 70% 30%, rgba(60,180,255,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Full width layout */
    .wrap{
      width: min(1400px, calc(100vw - 36px));
      margin: 0 auto;
      padding: 18px 0 44px;
    }
    @media (min-width: 1500px){
      .wrap{ width: calc(100vw - 48px); }
    }
    @media (max-width: 820px){
      .wrap{ width: calc(100vw - 22px); padding-top: 10px; }
    }

    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      margin-bottom: 10px;
    }
    h1{
      margin:0;
      font-size: 28px;
      letter-spacing:.2px;
    }
    .sub{
      margin:6px 0 0;
      font-size: 13px;
      color: var(--muted);
      opacity:.9;
      max-width: 900px;
    }

    /* Top bar */
    .bar{
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(to bottom, rgba(7,7,11,.92), rgba(7,7,11,.70));
      backdrop-filter: blur(10px);
      padding: 10px 0 12px;
      border-bottom: 1px solid rgba(34,34,58,.45);
      margin-bottom: 14px;
    }
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      padding: 12px;
      background: rgba(15,15,24,.72);
      border: 1px solid rgba(34,34,58,.75);
      border-radius: 14px;
      box-shadow: var(--shadow);
    }

    .group{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .seg{
      display:inline-flex;
      gap:6px;
      background: rgba(12,12,22,.85);
      border: 1px solid rgba(43,43,73,.9);
      border-radius: 12px;
      padding: 4px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
    }
    .seg button{
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text);
      cursor: pointer;
      font-size: 13px;
      line-height: 1;
      opacity:.9;
    }
    .seg button.active{
      background: rgba(126,199,255,.14);
      border-color: rgba(126,199,255,.22);
      color: #eaf6ff;
      opacity:1;
    }

    label{
      font-size: 13px;
      color: var(--muted);
      opacity: .95;
    }

    input[type="number"], input[type="text"]{
      height: 34px;
      padding: 0 10px;
      border-radius: 10px;
      border: 1px solid rgba(43,43,73,.95);
      background: rgba(12,12,22,.85);
      color: var(--text);
      outline:none;
    }
    input[type="number"]{ width: 76px; }
    input[type="text"]{ width: min(320px, 60vw); }

    .btn{
      height: 34px;
      padding: 0 12px;
      border-radius: 10px;
      border: 1px solid rgba(43,43,73,.95);
      background: rgba(20,20,36,.85);
      color: var(--text);
      cursor: pointer;
      font-size: 13px;
    }
    .btn:hover{ background: rgba(28,28,50,.92); }

    .chk{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(43,43,73,.9);
      background: rgba(12,12,22,.6);
      font-size: 13px;
      color: var(--muted);
      user-select:none;
    }
    .chk input{ accent-color: var(--accent); }

    .meta{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted2);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    /* Sections + cards */
    h2{
      margin: 18px 0 10px;
      font-size: 15px;
      letter-spacing:.2px;
      color: #dfe6ff;
      opacity:.95;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px;
    }
    @media (max-width: 1050px){
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 720px){
      .grid{ grid-template-columns: 1fr; gap: 12px; }
    }

    .card{
      position:relative;
      border-radius: var(--radius);
      border: 1px solid rgba(34,34,58,.85);
      background: linear-gradient(180deg, rgba(18,18,34,.9), rgba(10,10,18,.92));
      overflow:hidden;
      box-shadow: var(--shadow);
    }

    /* Mobile list alignment fix: use grid inside card so wrap doesn't shift stuff */
    .cardInner{
      display:grid;
      grid-template-columns: 82px 1fr 56px;
      gap: 12px;
      padding: 12px;
      align-items: start;
      min-height: 92px;
    }
    @media (max-width: 720px){
      .cardInner{
        grid-template-columns: 70px 1fr 52px;
        gap: 10px;
        padding: 12px;
      }
    }

    .poster{
      width: 70px;
      height: 70px;
      border-radius: 12px;
      border: 1px solid rgba(43,43,73,.85);
      background: rgba(12,12,22,.7);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
    }
    .poster img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }
    .poster .ph{
      font-size: 10px;
      color: rgba(167,167,194,.65);
      text-align:center;
      padding: 6px;
      line-height:1.2;
    }

    .title{
      font-size: 18px;
      font-weight: 720;
      margin: 0 0 6px;
      letter-spacing:.1px;
      line-height: 1.1;
    }
    @media (max-width: 720px){
      .title{ font-size: 18px; }
    }

    .badges{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin: 0 0 8px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(43,43,73,.9);
      background: rgba(12,12,22,.65);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .pill.red{
      border-color: rgba(255,107,122,.35);
      background: rgba(255,107,122,.10);
      color:#ffd6de;
    }
    .pill.gold{
      border-color: rgba(255,204,102,.35);
      background: rgba(255,204,102,.10);
      color:#ffe8bb;
    }

    /* Date beads */
    .beadsRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .monthChip{
      font-size: 12px;
      color: rgba(167,167,194,.72);
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(43,43,73,.65);
      background: rgba(12,12,22,.35);
    }
    .beads{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .bead{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(43,43,73,.9);
      background: rgba(12,12,22,.6);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      color: rgba(167,167,194,.8);
    }
    .bead.on{
      border-color: rgba(126,199,255,.65);
      box-shadow: 0 0 0 2px rgba(126,199,255,.08);
      color:#eaf6ff;
      background: rgba(126,199,255,.10);
      font-weight: 700;
    }
    .bead.today{
      outline: 2px solid rgba(81,216,138,.35);
      outline-offset: 2px;
    }

    /* Actions column */
    .actions{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
      padding-top: 2px;
    }
    .iconBtn{
      width: 34px;
      height: 34px;
      border-radius: 11px;
      border: 1px solid rgba(43,43,73,.95);
      background: rgba(12,12,22,.6);
      color: var(--text);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      line-height:1;
      opacity:.9;
    }
    .iconBtn:hover{ background: rgba(20,20,36,.72); opacity:1; }
    .iconBtn.dim{ opacity:.55; }

    .mutedCard{
      opacity:.55;
      filter: saturate(.75);
    }
    .mutedCard .beadsRow,
    .mutedCard .badges{
      display:none;
    }
    .mutedCard .cardInner{
      min-height: 76px;
    }

    /* Poster background toggle (aesthetic menace) */
    .posterBg{
      position:absolute;
      inset:0;
      background-size: cover;
      background-position: center;
      opacity: .18;
      filter: blur(0px) saturate(1.1);
      transform: scale(1.02);
    }
    .posterBg:after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(90deg, rgba(7,7,11,.92), rgba(7,7,11,.62) 55%, rgba(7,7,11,.90));
    }

    /* Drawer */
    .drawerBackdrop{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      z-index: 80;
      display:none;
    }
    .drawerBackdrop.open{ display:block; }
    .drawer{
      position: fixed;
      right: 18px;
      top: 18px;
      width: min(460px, calc(100vw - 36px));
      max-height: calc(100vh - 36px);
      overflow:auto;
      border-radius: 16px;
      border: 1px solid rgba(34,34,58,.9);
      background: rgba(12,12,22,.92);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      z-index: 90;
      display:none;
    }
    .drawer.open{ display:block; }
    @media (max-width: 720px){
      .drawer{
        right: 10px;
        left: 10px;
        width: auto;
        top: auto;
        bottom: 10px;
        max-height: 75vh;
      }
    }
    .drawerHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 12px 12px 8px;
      border-bottom: 1px solid rgba(34,34,58,.75);
    }
    .drawerTitle{
      font-weight: 800;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .drawerBody{ padding: 12px; }
    .drawerRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(34,34,58,.55);
      color: var(--muted);
      font-size: 13px;
    }
    .drawerRow:last-child{ border-bottom:none; }
    .drawerRow strong{ color: var(--text); font-weight:700; }

    .danger{
      border-color: rgba(255,107,122,.5) !important;
      background: rgba(255,107,122,.10) !important;
      color:#ffd6de !important;
    }

    .error{
      padding: 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,107,122,.45);
      background: rgba(255,107,122,.10);
      color:#ffd6de;
      white-space: pre-wrap;
      box-shadow: var(--shadow);
    }

    /* ===== Calendar (Desktop weekly grid) ===== */
    .calWrap{
      margin-top: 8px;
      border-radius: 16px;
      border: 1px solid rgba(34,34,58,.85);
      background: rgba(12,12,22,.6);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .calTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 12px;
      gap: 10px;
      border-bottom: 1px solid rgba(34,34,58,.75);
    }
    .calRange{
      font-weight: 800;
      letter-spacing:.2px;
    }
    .calNav{
      display:flex;
      gap:8px;
      align-items:center;
    }

    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, minmax(0,1fr));
      gap: 0;
      min-height: 460px;
    }
    .calDay{
      border-right: 1px solid rgba(34,34,58,.6);
      border-bottom: 1px solid rgba(34,34,58,.6);
      padding: 10px;
      min-height: 180px;
    }
    .calDay:last-child{ border-right:none; }
    .calDayHead{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      margin-bottom: 8px;
      color: var(--muted);
      font-size: 12px;
    }
    .calDayHead strong{
      color:#eaf6ff;
      font-size: 12px;
      font-weight: 800;
    }
    .calItems{
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .calItem{
      position: relative;
      border-radius: 12px;
      border: 1px solid rgba(43,43,73,.85);
      background: rgba(10,10,18,.72);
      padding: 8px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      cursor: pointer;
      overflow:hidden;
    }
    .calItem .dot{
      width: 10px; height: 10px; border-radius: 999px;
      background: rgba(126,199,255,.6);
      border: 1px solid rgba(126,199,255,.45);
      flex: 0 0 auto;
    }
    .calItem .name{
      flex: 1 1 auto;
      min-width: 0;
      font-size: 12px;
      color: #eaeaf2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .calItem .mini{
      display:flex;
      gap:6px;
      flex: 0 0 auto;
      opacity:.9;
    }
    .miniBtn{
      width: 26px; height: 26px;
      border-radius: 10px;
      border: 1px solid rgba(43,43,73,.9);
      background: rgba(12,12,22,.55);
      color:#eaeaf2;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 14px;
    }
    .miniBtn:hover{ background: rgba(20,20,36,.75); }

    /* optional poster background in calendar items */
    .calItem.bg{
      background-size: cover;
      background-position: center;
    }
    .calItem.bg:before{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(90deg, rgba(7,7,11,.88), rgba(7,7,11,.52) 55%, rgba(7,7,11,.90));
    }
    .calItem.bg > *{ position: relative; z-index: 1; }

    /* Muted in calendar: dim + push down if option enabled */
    .calItem.muted{ opacity:.55; }

    /* ===== Mobile Calendar (Day view) ===== */
    .mcal{
      display:none;
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid rgba(34,34,58,.85);
      background: rgba(12,12,22,.6);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .mcalHead{
      position: sticky;
      top: 0;
      z-index: 55;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      padding: 10px;
      border-bottom: 1px solid rgba(34,34,58,.75);
      background: rgba(7,7,11,.65);
      backdrop-filter: blur(10px);
    }
    .mcalHead .left{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .mcalTitle{
      font-weight: 900;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .mcalHead .right{
      display:flex;
      gap: 8px;
      align-items:center;
      flex: 0 0 auto;
    }
    .mcalBody{
      padding: 10px;
    }
    .mcalList{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .mItem{
      position: relative;
      border-radius: 14px;
      border: 1px solid rgba(43,43,73,.85);
      background: rgba(10,10,18,.72);
      padding: 10px;
      display:grid;
      grid-template-columns: 44px 1fr;
      gap: 10px;
      overflow:hidden;
      cursor:pointer;
    }
    .mItem.bg{
      background-size: cover;
      background-position: center;
    }
    .mItem.bg:before{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(90deg, rgba(7,7,11,.92), rgba(7,7,11,.55) 62%, rgba(7,7,11,.92));
    }
    .mItem.bg > *{ position: relative; z-index:1; }

    .mPoster{
      width: 44px;
      height: 44px;
      border-radius: 12px;
      overflow:hidden;
      border: 1px solid rgba(43,43,73,.75);
      background: rgba(12,12,22,.55);
    }
    .mPoster img{ width:100%; height:100%; object-fit: cover; display:block; }

    .mName{
      font-weight: 800;
      font-size: 14px;
      line-height: 1.15;
      margin: 0 0 6px;
    }
    .mMeta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      color: rgba(167,167,194,.85);
      font-size: 12px;
    }
    .mDot{
      width: 8px; height: 8px; border-radius: 999px;
      background: rgba(126,199,255,.6);
      border: 1px solid rgba(126,199,255,.4);
    }
    .mTag{
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(43,43,73,.85);
      background: rgba(12,12,22,.45);
      font-size: 12px;
    }
    .mTag.red{ border-color: rgba(255,107,122,.35); background: rgba(255,107,122,.10); color:#ffd6de; }
    .mTag.gold{ border-color: rgba(255,204,102,.35); background: rgba(255,204,102,.10); color:#ffe8bb; }

    .mEmpty{
      padding: 14px;
      color: var(--muted);
      border-radius: 14px;
      border: 1px dashed rgba(43,43,73,.9);
      background: rgba(12,12,22,.35);
    }

    /* Show/Hide calendar blocks based on width */
    @media (max-width: 760px){
      .calWrap{ display:none; }
      .mcal{ display:block; }
      /* tighten list cards slightly */
      .title{ font-size: 18px; }
    }

    a{ color: var(--accent); text-decoration:none; }
    a:hover{ text-decoration: underline; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Kalispell Showtimes</h1>
        <div class="sub">
          List mode is “scan mode.” Calendar mode is date based (not showtime times yet).
          Tap a movie to open details. Muted collapses it. Hidden removes it.
        </div>
      </div>
    </header>

    <div class="bar">
      <div class="controls">
        <!-- Views -->
        <div class="group">
          <div class="seg" role="tablist" aria-label="Views">
            <button id="viewList" class="active" type="button">List</button>
            <button id="viewCal" type="button">Calendar</button>
          </div>
        </div>

        <!-- Inputs -->
        <div class="group">
          <label for="days">Days ahead</label>
          <input id="days" type="number" min="1" max="365" value="60"/>
          <button class="btn" id="go" type="button">Refresh</button>
          <button class="btn" id="debug" type="button">Debug</button>
          <input id="search" type="text" placeholder="search titles..." />
        </div>

        <!-- Filters -->
        <div class="group">
          <label class="chk"><input id="grouped" type="checkbox" checked> grouped</label>
          <label class="chk"><input id="onlyLeaving" type="checkbox"> leaving soon</label>
          <label class="chk"><input id="mutedBottom" type="checkbox" checked> muted to bottom</label>
          <label class="chk"><input id="posterBgToggle" type="checkbox"> poster bg</label>
          <button class="btn" id="manage" type="button">Manage hidden + muted</button>
        </div>

        <!-- Sort / density -->
        <div class="group" style="margin-left:auto;">
          <div class="seg" aria-label="Sort">
            <button id="sortPlan" class="active" type="button">Plan</button>
            <button id="sortLong" type="button">Long</button>
            <button id="sortShort" type="button">Short</button>
          </div>
        </div>
      </div>

      <div class="meta" id="meta"></div>
    </div>

    <div id="out"></div>

    <!-- Desktop calendar -->
    <div class="calWrap" id="calWrap" style="display:none;">
      <div class="calTop">
        <div class="calRange" id="calRange">Calendar</div>
        <div class="calNav">
          <button class="btn" id="calPrev" type="button">◀</button>
          <button class="btn" id="calToday" type="button">Today</button>
          <button class="btn" id="calNext" type="button">▶</button>
        </div>
      </div>
      <div class="calGrid" id="calGrid"></div>
    </div>

    <!-- Mobile day calendar -->
    <div class="mcal" id="mcal" style="display:none;">
      <div class="mcalHead">
        <div class="left">
          <button class="btn" id="mPrev" type="button">◀</button>
          <div class="mcalTitle" id="mTitle">Today</div>
          <button class="btn" id="mNext" type="button">▶</button>
        </div>
        <div class="right">
          <button class="btn" id="mToday" type="button">Today</button>
        </div>
      </div>
      <div class="mcalBody">
        <div class="mcalList" id="mList"></div>
      </div>
    </div>
  </div>

  <!-- Drawer -->
  <div id="drawerBackdrop" class="drawerBackdrop"></div>
  <div id="drawer" class="drawer" role="dialog" aria-modal="true">
    <div class="drawerHead">
      <div class="drawerTitle" id="drawerTitle">Movie</div>
      <button class="btn" id="drawerClose" type="button">Close</button>
    </div>
    <div class="drawerBody" id="drawerBody"></div>
  </div>

<script>
(() => {
  const out = document.getElementById("out");
  const meta = document.getElementById("meta");

  const daysEl = document.getElementById("days");
  const searchEl = document.getElementById("search");

  const viewListBtn = document.getElementById("viewList");
  const viewCalBtn = document.getElementById("viewCal");

  const groupedEl = document.getElementById("grouped");
  const onlyLeavingEl = document.getElementById("onlyLeaving");
  const mutedBottomEl = document.getElementById("mutedBottom");
  const posterBgToggleEl = document.getElementById("posterBgToggle");

  const sortPlanBtn = document.getElementById("sortPlan");
  const sortLongBtn = document.getElementById("sortLong");
  const sortShortBtn = document.getElementById("sortShort");

  const calWrap = document.getElementById("calWrap");
  const calRange = document.getElementById("calRange");
  const calGrid = document.getElementById("calGrid");
  const calPrev = document.getElementById("calPrev");
  const calNext = document.getElementById("calNext");
  const calToday = document.getElementById("calToday");

  const mcal = document.getElementById("mcal");
  const mTitle = document.getElementById("mTitle");
  const mList = document.getElementById("mList");
  const mPrev = document.getElementById("mPrev");
  const mNext = document.getElementById("mNext");
  const mToday = document.getElementById("mToday");

  const drawerBackdrop = document.getElementById("drawerBackdrop");
  const drawer = document.getElementById("drawer");
  const drawerTitle = document.getElementById("drawerTitle");
  const drawerBody = document.getElementById("drawerBody");
  const drawerClose = document.getElementById("drawerClose");

  // Local storage keys
  const LS = {
    hidden: "kshow_hidden_v1",
    muted: "kshow_muted_v1",
    view: "kshow_view_v1",
    sort: "kshow_sort_v1",
    grouped: "kshow_grouped_v1",
    onlyLeaving: "kshow_onlyLeaving_v1",
    mutedBottom: "kshow_mutedBottom_v1",
    posterBg: "kshow_posterBg_v1",
    days: "kshow_days_v1",
    search: "kshow_search_v1",
    calAnchor: "kshow_calAnchor_v1",
    mAnchor: "kshow_mAnchor_v1",
  };

  function loadJSON(key, fallback){
    try { return JSON.parse(localStorage.getItem(key) || "") ?? fallback; } catch { return fallback; }
  }
  function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

  function normTitle(t){
    return (t||"").toLowerCase().replace(/[^a-z0-9]+/g,"").trim();
  }
  function esc(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }
  function isoToDate(iso){
    // iso like 2026-01-12
    const [y,m,d] = iso.split("-").map(n => parseInt(n,10));
    return new Date(y, m-1, d);
  }
  function sameDay(a,b){
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  }
  function fmtMonthDay(d){
    const mo = d.toLocaleString(undefined,{month:"short"});
    return `${mo} ${d.getDate()}`;
  }
  function fmtDowMonthDay(d){
    const dow = d.toLocaleString(undefined,{weekday:"short"});
    const mo = d.toLocaleString(undefined,{month:"short"});
    return `${dow} ${mo} ${d.getDate()}`;
  }
  function fmtRange(a,b){
    const aStr = fmtMonthDay(a);
    const bStr = fmtMonthDay(b);
    const yr = a.getFullYear();
    return `${aStr} – ${bStr}, ${yr}`;
  }

  // State
  let state = {
    movies: [],
    generated_at: "",
    source: "",
    days_ahead: 60,
    view: "list",   // list | cal
    sort: "plan",   // plan | long | short
    hidden: new Set(loadJSON(LS.hidden, [])),
    muted: new Set(loadJSON(LS.muted, [])),
    calAnchor: loadJSON(LS.calAnchor, null),
    mAnchor: loadJSON(LS.mAnchor, null),
  };

  // Restore UI prefs
  (function restorePrefs(){
    const d = parseInt(localStorage.getItem(LS.days) || "60", 10);
    daysEl.value = String(Math.max(1, Math.min(365, isNaN(d)?60:d)));

    searchEl.value = localStorage.getItem(LS.search) || "";

    groupedEl.checked = (localStorage.getItem(LS.grouped) ?? "true") === "true";
    onlyLeavingEl.checked = (localStorage.getItem(LS.onlyLeaving) ?? "false") === "true";
    mutedBottomEl.checked = (localStorage.getItem(LS.mutedBottom) ?? "true") === "true";
    posterBgToggleEl.checked = (localStorage.getItem(LS.posterBg) ?? "false") === "true";

    state.view = (localStorage.getItem(LS.view) || "list");
    state.sort = (localStorage.getItem(LS.sort) || "plan");
  })();

  function setView(v){
    state.view = v;
    localStorage.setItem(LS.view, v);
    viewListBtn.classList.toggle("active", v==="list");
    viewCalBtn.classList.toggle("active", v==="cal");

    // list vs calendar containers
    if (v==="list"){
      calWrap.style.display = "none";
      mcal.style.display = "none";
      out.style.display = "block";
    } else {
      out.style.display = "none";
      // responsive: desktop weekly calendar uses calWrap, mobile uses mcal via CSS media query
      calWrap.style.display = "block";
      mcal.style.display = "block";
    }

    render();
  }

  function setSort(s){
    state.sort = s;
    localStorage.setItem(LS.sort, s);
    sortPlanBtn.classList.toggle("active", s==="plan");
    sortLongBtn.classList.toggle("active", s==="long");
    sortShortBtn.classList.toggle("active", s==="short");
    render();
  }

  function persistChecks(){
    localStorage.setItem(LS.grouped, String(groupedEl.checked));
    localStorage.setItem(LS.onlyLeaving, String(onlyLeavingEl.checked));
    localStorage.setItem(LS.mutedBottom, String(mutedBottomEl.checked));
    localStorage.setItem(LS.posterBg, String(posterBgToggleEl.checked));
  }

  // Drawer
  function closeDrawer(){
    drawerBackdrop.classList.remove("open");
    drawer.classList.remove("open");
  }
  function openDrawer(movie){
    const n = normTitle(movie.title);
    const isHidden = state.hidden.has(n);
    const isMuted = state.muted.has(n);

    drawerTitle.textContent = movie.title;

    const showDates = (movie.show_dates || []).map(isoToDate);
    const today = new Date();
    const next = showDates.find(d => d >= startOfDay(today)) || null;
    const end = showDates.length ? showDates[showDates.length-1] : null;

    const nextText = next ? fmtDowMonthDay(next) : "none found";
    const endIn = end ? Math.round((startOfDay(end) - startOfDay(today)) / 86400000) : null;

    const leavingSoon = endIn !== null && endIn >= 0 && endIn <= 2;
    const shortRun = (movie.run_length_days || 0) <= 3;

    drawerBody.innerHTML = `
      <div class="drawerRow"><span>Status</span><strong>${isHidden ? "Hidden" : (isMuted ? "Muted" : "Normal")}</strong></div>
      <div class="drawerRow"><span>Next showing</span><strong>${esc(nextText)}</strong></div>
      <div class="drawerRow"><span>Ends in</span><strong>${endIn === null ? "?" : (endIn < 0 ? `${Math.abs(endIn)} days ago` : `${endIn} days`)}</strong></div>
      <div class="drawerRow"><span>Listed days</span><strong>${movie.run_length_days || 0}</strong></div>
      <div class="drawerRow"><span>Flags</span><strong>${leavingSoon ? "Leaving soon" : "—"} ${shortRun ? " Short run" : ""}</strong></div>

      <div style="margin:12px 0 8px; color: var(--muted); font-size:12px;">Show dates</div>
      <div class="beads" style="gap:8px; margin-bottom: 12px;">
        ${(movie.show_dates || []).map(iso => {
          const d = isoToDate(iso);
          const day = d.getDate();
          const on = true;
          const isToday = sameDay(d, today);
          return `<div class="bead on ${isToday ? "today" : ""}" title="${esc(fmtDowMonthDay(d))}">${day}</div>`;
        }).join("")}
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn ${isMuted ? "" : ""}" id="drawerMute">${isMuted ? "Unmute" : "Mute"}</button>
        <button class="btn danger" id="drawerHide">${isHidden ? "Unhide" : "Hide"}</button>
      </div>

      <div style="margin-top:12px; color: rgba(167,167,194,.7); font-size:12px;">
        Tip: Mute collapses the card. Hide removes it completely (until you unhide it in Manage).
      </div>
    `;

    drawerBackdrop.classList.add("open");
    drawer.classList.add("open");

    document.getElementById("drawerMute").onclick = () => {
      toggleMuted(n);
      openDrawer(movie); // refresh drawer content
      render();
    };
    document.getElementById("drawerHide").onclick = () => {
      toggleHidden(n);
      openDrawer(movie);
      render();
    };
  }

  drawerBackdrop.addEventListener("click", closeDrawer);
  drawerClose.addEventListener("click", closeDrawer);
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeDrawer(); });

  function startOfDay(d){
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  }

  // Hidden / Muted
  function toggleHidden(n){
    if (state.hidden.has(n)) state.hidden.delete(n);
    else state.hidden.add(n);
    saveJSON(LS.hidden, Array.from(state.hidden));
  }
  function toggleMuted(n){
    if (state.muted.has(n)) state.muted.delete(n);
    else state.muted.add(n);
    saveJSON(LS.muted, Array.from(state.muted));
  }

  // Manage drawer (hidden + muted)
  function openManage(){
    const hidden = Array.from(state.hidden).sort();
    const muted = Array.from(state.muted).sort();

    drawerTitle.textContent = "Manage hidden + muted";
    drawerBody.innerHTML = `
      <div style="color: var(--muted); font-size:12px; margin-bottom:10px;">
        Hidden = removed entirely. Muted = collapsed + dimmed (and can be pushed to bottom).
      </div>

      <div style="margin:10px 0 6px; font-weight:800;">Hidden (${hidden.length})</div>
      ${hidden.length ? hidden.map(n => `
        <div class="drawerRow">
          <span>${esc(n)}</span>
          <button class="btn danger" data-unhide="${esc(n)}">Unhide</button>
        </div>
      `).join("") : `<div style="color: rgba(167,167,194,.7); font-size:12px;">None</div>`}

      <div style="margin:14px 0 6px; font-weight:800;">Muted (${muted.length})</div>
      ${muted.length ? muted.map(n => `
        <div class="drawerRow">
          <span>${esc(n)}</span>
          <button class="btn" data-unmute="${esc(n)}">Unmute</button>
        </div>
      `).join("") : `<div style="color: rgba(167,167,194,.7); font-size:12px;">None</div>`}
    `;

    drawerBackdrop.classList.add("open");
    drawer.classList.add("open");

    drawerBody.querySelectorAll("[data-unhide]").forEach(btn => {
      btn.addEventListener("click", () => {
        const n = btn.getAttribute("data-unhide");
        toggleHidden(n);
        openManage();
        render();
      });
    });
    drawerBody.querySelectorAll("[data-unmute]").forEach(btn => {
      btn.addEventListener("click", () => {
        const n = btn.getAttribute("data-unmute");
        toggleMuted(n);
        openManage();
        render();
      });
    });
  }

  // Fetch data
  async function load(){
    const days = Math.max(1, Math.min(365, parseInt(daysEl.value || "60", 10)));
    daysEl.value = String(days);
    localStorage.setItem(LS.days, String(days));

    meta.textContent = "Loading…";

    try{
      const res = await fetch(`/api/showtimes?days=${days}`, { cache: "no-store" });
      const data = await res.json();

      if (!res.ok || data.error){
        meta.textContent = "";
        out.innerHTML = `<div class="error">${esc("Error: " + (data.error || res.statusText) + "\n\nDebug:\n" + JSON.stringify(data.debug || {}, null, 2))}</div>`;
        return;
      }

      // Convert "range summary" to explicit show dates if server didn't provide
      // We will prefer data.movies[*].show_dates if present. Otherwise build from first->last inclusive (but your scraper doesn't support gaps).
      // Good news: your server likely already provides show_dates now. If not, we still show range beads, but it will include gaps.
      const today = startOfDay(new Date());

      state.generated_at = data.generated_at || "";
      state.source = data.source || "";
      state.days_ahead = data.days_ahead || days;

      state.movies = (data.movies || []).map(m => {
        const title = m.title || "Untitled";
        const n = normTitle(title);

        // poster fields - accept a few names
        const poster = m.poster_url || m.poster || m.poster_path || m.tmdb_poster_url || null;

        // show_dates: prefer explicit list
        let showDates = Array.isArray(m.show_dates) ? m.show_dates.slice() : null;

        // fallback: if only first_date/last_date exist, generate inclusive days (may include gaps)
        if (!showDates && m.first_date && m.last_date){
          const a = isoToDate(m.first_date);
          const b = isoToDate(m.last_date);
          const list = [];
          let cur = startOfDay(a);
          const end = startOfDay(b);
          while (cur <= end){
            list.push(cur.toISOString().slice(0,10));
            cur = new Date(cur.getFullYear(), cur.getMonth(), cur.getDate()+1);
          }
          showDates = list;
        }

        // If still none, at least show first/last if present
        if (!showDates) showDates = [];

        // compute next showing + ends in
        const showDateObjs = showDates.map(isoToDate).sort((x,y)=>x-y);
        const next = showDateObjs.find(d => d >= today) || null;
        const last = showDateObjs.length ? showDateObjs[showDateObjs.length-1] : null;

        const endsIn = last ? Math.round((startOfDay(last) - today)/86400000) : null;
        const leavingSoon = endsIn !== null && endsIn >= 0 && endsIn <= 2;
        const runLen = m.run_length_days ?? showDates.length ?? 0;
        const shortRun = runLen <= 3;

        // "plan score" for sorting
        const daysUntil = next ? Math.round((startOfDay(next) - today)/86400000) : 9999;
        const planScore =
          (leavingSoon ? 3 : 0) +
          (shortRun ? 2 : 0) +
          (daysUntil === 0 ? 2 : daysUntil === 1 ? 1 : 0) +
          (poster ? 1 : 0);

        return {
          ...m,
          title,
          norm: n,
          poster,
          show_dates: showDates,
          _next: next,
          _last: last,
          _endsIn: endsIn,
          _leavingSoon: leavingSoon,
          _shortRun: shortRun,
          _runLen: runLen,
          _daysUntil: daysUntil,
          _planScore: planScore
        };
      });

      meta.textContent = `Generated: ${state.generated_at}   Source: ${state.source}   Days ahead: ${state.days_ahead}`;
      render();
    } catch (e){
      meta.textContent = "";
      out.innerHTML = `<div class="error">${esc("Request failed: " + e)}</div>`;
    }
  }

  // Filters + sorting
  function filteredMovies(){
    const q = (searchEl.value || "").trim().toLowerCase();
    localStorage.setItem(LS.search, searchEl.value || "");

    const onlyLeaving = onlyLeavingEl.checked;

    let movies = state.movies.slice();

    // remove hidden
    movies = movies.filter(m => !state.hidden.has(m.norm));

    // search
    if (q){
      movies = movies.filter(m => (m.title || "").toLowerCase().includes(q));
    }

    // leaving soon filter
    if (onlyLeaving){
      movies = movies.filter(m => m._leavingSoon);
    }

    // muted to bottom
    if (mutedBottomEl.checked){
      const a = [];
      const b = [];
      for (const m of movies){
        (state.muted.has(m.norm) ? b : a).push(m);
      }
      movies = a.concat(b);
    }

    // sort
    if (state.sort === "plan"){
      movies.sort((x,y) => {
        // higher planScore first, then ends sooner, then title
        const ps = (y._planScore - x._planScore);
        if (ps) return ps;
        const ei = (x._endsIn ?? 9999) - (y._endsIn ?? 9999);
        if (ei) return ei;
        return (x.title || "").localeCompare(y.title || "");
      });
    } else if (state.sort === "long"){
      movies.sort((x,y) => (y._runLen - x._runLen) || (x._daysUntil - y._daysUntil) || (x.title||"").localeCompare(y.title||""));
    } else if (state.sort === "short"){
      movies.sort((x,y) => (x._runLen - y._runLen) || (x._daysUntil - y._daysUntil) || (x.title||"").localeCompare(y.title||""));
    }

    return movies;
  }

  // Grouping: Now, Next 7, Later, Muted (optional)
  function groupMovies(movies){
    const today = startOfDay(new Date());
    const in7 = new Date(today.getFullYear(), today.getMonth(), today.getDate()+7);

    const groups = { now: [], next7: [], later: [], muted: [] };

    for (const m of movies){
      const isMuted = state.muted.has(m.norm);

      // determine if showing today or within next 7 days
      const next = m._next ? startOfDay(m._next) : null;

      let bucket = "later";
      if (!next) bucket = "later";
      else if (next <= today) bucket = "now";
      else if (next <= in7) bucket = "next7";
      else bucket = "later";

      if (isMuted && mutedBottomEl.checked){
        groups.muted.push(m);
      } else {
        groups[bucket].push(m);
      }
    }
    return groups;
  }

  // Render list cards
  function listCard(m){
    const isMuted = state.muted.has(m.norm);
    const leavingSoon = m._leavingSoon;
    const shortRun = m._shortRun;

    const poster = m.poster ? `<img src="${esc(m.poster)}" alt="${esc(m.title)} poster" loading="lazy" />` : `<div class="ph">no poster</div>`;

    // beads: show only actual show_dates (no gaps) if provided
    const dates = (m.show_dates || []).map(isoToDate).sort((a,b)=>a-b);
    const today = new Date();
    const monthLabel = dates.length ? dates[0].toLocaleString(undefined,{month:"short"}) : "";

    const beadsHtml = dates.map(d => {
      const on = true;
      const isToday = sameDay(d, today);
      return `<div class="bead ${on ? "on" : ""} ${isToday ? "today" : ""}" title="${esc(fmtDowMonthDay(d))}">${d.getDate()}</div>`;
    }).join("");

    // poster background (optional)
    const bgOn = posterBgToggleEl.checked && m.poster;
    const bg = bgOn ? `<div class="posterBg" style="background-image:url('${esc(m.poster)}')"></div>` : "";

    return `
      <div class="card ${isMuted ? "mutedCard" : ""}" data-open="${esc(m.norm)}">
        ${bg}
        <div class="cardInner">
          <div class="poster" aria-hidden="true">${poster}</div>

          <div>
            <div class="title">${esc(m.title)}</div>
            <div class="badges">
              ${leavingSoon ? `<span class="pill red">LEAVING SOON</span>` : ``}
              ${shortRun ? `<span class="pill gold">SHORT RUN</span>` : ``}
              <span class="pill">${m._runLen} day${m._runLen===1?"":"s"}</span>
            </div>

            ${isMuted ? `` : `
              <div class="beadsRow">
                ${monthLabel ? `<span class="monthChip">${esc(monthLabel)}</span>` : ``}
                <div class="beads">${beadsHtml || `<span style="color:rgba(167,167,194,.7);font-size:12px;">no dates found</span>`}</div>
              </div>
            `}
          </div>

          <div class="actions" aria-label="actions">
            <button class="iconBtn ${isMuted ? "dim" : ""}" title="${isMuted ? "Unmute" : "Mute"}" data-mute="${esc(m.norm)}">−</button>
            <button class="iconBtn" title="Hide" data-hide="${esc(m.norm)}">×</button>
          </div>
        </div>
      </div>
    `;
  }

  function renderList(){
    const movies = filteredMovies();

    if (!movies.length){
      out.innerHTML = `<div class="error">No movies found (filters/search might be hiding them, or the scrape returned nothing).</div>`;
      return;
    }

    const grouped = groupedEl.checked;

    if (!grouped){
      out.innerHTML = `<div class="grid">${movies.map(listCard).join("")}</div>`;
      wireCardButtons();
      return;
    }

    const g = groupMovies(movies);

    const parts = [];
    if (g.now.length){
      parts.push(`<h2>Now</h2><div class="grid">${g.now.map(listCard).join("")}</div>`);
    }
    if (g.next7.length){
      parts.push(`<h2>Next 7 days</h2><div class="grid">${g.next7.map(listCard).join("")}</div>`);
    }
    if (g.later.length){
      parts.push(`<h2>Later</h2><div class="grid">${g.later.map(listCard).join("")}</div>`);
    }
    if (g.muted.length){
      parts.push(`<h2>Muted</h2><div class="grid">${g.muted.map(listCard).join("")}</div>`);
    }

    out.innerHTML = parts.join("");
    wireCardButtons();
  }

  function wireCardButtons(){
    // open drawer on card tap (but ignore button taps)
    out.querySelectorAll("[data-open]").forEach(card => {
      card.addEventListener("click", (e) => {
        const t = e.target;
        if (t && (t.closest("[data-mute]") || t.closest("[data-hide]"))) return;
        const n = card.getAttribute("data-open");
        const m = state.movies.find(x => x.norm === n);
        if (m) openDrawer(m);
      });
    });

    out.querySelectorAll("[data-mute]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const n = btn.getAttribute("data-mute");
        toggleMuted(n);
        render();
      });
    });
    out.querySelectorAll("[data-hide]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const n = btn.getAttribute("data-hide");
        toggleHidden(n);
        render();
      });
    });
  }

  // ===== Calendar rendering =====
  function getCalendarItemsByDate(movies){
    // map dateIso -> list of movies
    const map = new Map();
    for (const m of movies){
      const isMuted = state.muted.has(m.norm);
      for (const iso of (m.show_dates || [])){
        if (!map.has(iso)) map.set(iso, []);
        map.get(iso).push({ movie: m, muted: isMuted });
      }
    }
    // sort each day's list: non-muted first (if option), then plan score
    for (const [iso, arr] of map.entries()){
      arr.sort((a,b) => {
        if (mutedBottomEl.checked && a.muted !== b.muted) return a.muted ? 1 : -1;
        const ps = (b.movie._planScore - a.movie._planScore);
        if (ps) return ps;
        return (a.movie.title||"").localeCompare(b.movie.title||"");
      });
    }
    return map;
  }

  function setCalAnchor(d){
    state.calAnchor = d.toISOString().slice(0,10);
    saveJSON(LS.calAnchor, state.calAnchor);
  }
  function getCalAnchor(){
    if (state.calAnchor){
      const d = isoToDate(state.calAnchor);
      if (!isNaN(d)) return startOfDay(d);
    }
    return startOfDay(new Date());
  }

  function renderDesktopCalendar(){
    const movies = filteredMovies();
    const map = getCalendarItemsByDate(movies);

    // anchor week (Sunday start)
    const anchor = getCalAnchor();
    const day = anchor.getDay(); // 0 Sun
    const weekStart = new Date(anchor.getFullYear(), anchor.getMonth(), anchor.getDate() - day);
    const weekEnd = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate()+6);

    calRange.textContent = fmtRange(weekStart, weekEnd);

    // build 7 days
    const days = [];
    for (let i=0;i<7;i++){
      const d = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate()+i);
      const iso = d.toISOString().slice(0,10);
      const items = map.get(iso) || [];

      const headDow = d.toLocaleString(undefined,{weekday:"short"}).toUpperCase();
      const headMo = d.toLocaleString(undefined,{month:"short"});
      const headDay = d.getDate();

      const itemsHtml = items.slice(0, 10).map(({movie, muted}) => {
        const leavingSoon = movie._leavingSoon;
        const shortRun = movie._shortRun;

        const dotColor = leavingSoon ? "rgba(255,107,122,.8)" : shortRun ? "rgba(255,204,102,.8)" : "rgba(126,199,255,.65)";
        const bgOn = posterBgToggleEl.checked && movie.poster;
        const bgStyle = bgOn ? `style="background-image:url('${esc(movie.poster)}')"` : "";
        const bgClass = bgOn ? "bg" : "";

        return `
          <div class="calItem ${muted ? "muted" : ""} ${bgClass}" ${bgStyle} title="${esc(movie.title)}" data-open="${esc(movie.norm)}">
            <div class="dot" style="background:${dotColor}; border-color:${dotColor};"></div>
            <div class="name">${esc(movie.title)}</div>
            <div class="mini">
              <div class="miniBtn" data-mute="${esc(movie.norm)}" title="${muted ? "Unmute" : "Mute"}">−</div>
              <div class="miniBtn" data-hide="${esc(movie.norm)}" title="Hide">×</div>
            </div>
          </div>
        `;
      }).join("");

      const more = items.length > 10 ? `<div style="margin-top:6px;color:rgba(167,167,194,.75);font-size:12px;">+${items.length-10} more</div>` : "";

      days.push(`
        <div class="calDay">
          <div class="calDayHead">
            <strong>${headDow}</strong>
            <span>${headMo} ${headDay}</span>
          </div>
          <div class="calItems">
            ${itemsHtml || `<div style="color:rgba(167,167,194,.65);font-size:12px;">nothing</div>`}
            ${more}
          </div>
        </div>
      `);
    }

    calGrid.innerHTML = days.join("");

    // wire calendar controls
    calGrid.querySelectorAll("[data-open]").forEach(el => {
      el.addEventListener("click", (e) => {
        const t = e.target;
        if (t && (t.closest("[data-mute]") || t.closest("[data-hide]"))) return;
        const n = el.getAttribute("data-open");
        const m = state.movies.find(x => x.norm === n);
        if (m) openDrawer(m);
      });
    });
    calGrid.querySelectorAll("[data-mute]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        toggleMuted(btn.getAttribute("data-mute"));
        render();
      });
    });
    calGrid.querySelectorAll("[data-hide]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        toggleHidden(btn.getAttribute("data-hide"));
        render();
      });
    });
  }

  function setMobileAnchor(d){
    state.mAnchor = d.toISOString().slice(0,10);
    saveJSON(LS.mAnchor, state.mAnchor);
  }
  function getMobileAnchor(){
    if (state.mAnchor){
      const d = isoToDate(state.mAnchor);
      if (!isNaN(d)) return startOfDay(d);
    }
    return startOfDay(new Date());
  }

  function renderMobileDayCalendar(){
    const movies = filteredMovies();
    const map = getCalendarItemsByDate(movies);

    const anchor = getMobileAnchor();
    const iso = anchor.toISOString().slice(0,10);
    const items = map.get(iso) || [];

    mTitle.textContent = fmtDowMonthDay(anchor);

    if (!items.length){
      mList.innerHTML = `<div class="mEmpty">Nothing listed this day. Swipe to another day or hit Today.</div>`;
      return;
    }

    const html = items.map(({movie, muted}) => {
      const leavingSoon = movie._leavingSoon;
      const shortRun = movie._shortRun;

      const dotColor = leavingSoon ? "rgba(255,107,122,.8)" : shortRun ? "rgba(255,204,102,.8)" : "rgba(126,199,255,.65)";
      const bgOn = posterBgToggleEl.checked && movie.poster;
      const bgStyle = bgOn ? `style="background-image:url('${esc(movie.poster)}')"` : "";
      const bgClass = bgOn ? "bg" : "";

      const poster = movie.poster ? `<img src="${esc(movie.poster)}" alt="" loading="lazy"/>` : "";

      return `
        <div class="mItem ${bgClass} ${muted ? "muted" : ""}" ${bgStyle} data-open="${esc(movie.norm)}">
          <div class="mPoster">${poster}</div>
          <div>
            <div class="mName">${esc(movie.title)}</div>
            <div class="mMeta">
              <span class="mDot" style="background:${dotColor}; border-color:${dotColor};"></span>
              ${leavingSoon ? `<span class="mTag red">Leaving soon</span>` : ``}
              ${shortRun ? `<span class="mTag gold">Short run</span>` : ``}
              <span class="mTag">${movie._runLen} day${movie._runLen===1?"":"s"}</span>
            </div>
          </div>
        </div>
      `;
    }).join("");

    mList.innerHTML = html;

    // tap opens drawer (mute/hide inside drawer on mobile, keeps this clean)
    mList.querySelectorAll("[data-open]").forEach(el => {
      el.addEventListener("click", () => {
        const n = el.getAttribute("data-open");
        const m = state.movies.find(x => x.norm === n);
        if (m) openDrawer(m);
      });
    });
  }

  function renderCalendar(){
    renderDesktopCalendar();
    renderMobileDayCalendar();
  }

  // Render master
  function render(){
    persistChecks();

    // Show correct view containers
    if (state.view === "list"){
      out.style.display = "block";
      calWrap.style.display = "none";
      mcal.style.display = "none";
      renderList();
    } else {
      out.style.display = "none";
      calWrap.style.display = "block";
      mcal.style.display = "block";
      renderCalendar();
    }
  }

  // Debug
  async function debugFetch(){
    meta.textContent = "Running debug…";
    out.innerHTML = "";
    try{
      const res = await fetch(`/api/debug_raw`, { cache: "no-store" });
      const data = await res.json();
      meta.textContent = "";
      out.style.display = "block";
      calWrap.style.display = "none";
      mcal.style.display = "none";
      out.innerHTML = `<div class="error">${esc(JSON.stringify(data, null, 2))}</div>`;
    } catch(e){
      meta.textContent = "";
      out.innerHTML = `<div class="error">${esc("Debug failed: " + e)}</div>`;
    }
  }

  // Events
  document.getElementById("go").addEventListener("click", load);
  document.getElementById("debug").addEventListener("click", debugFetch);

  searchEl.addEventListener("input", () => render());
  groupedEl.addEventListener("change", () => { persistChecks(); render(); });
  onlyLeavingEl.addEventListener("change", () => { persistChecks(); render(); });
  mutedBottomEl.addEventListener("change", () => { persistChecks(); render(); });
  posterBgToggleEl.addEventListener("change", () => { persistChecks(); render(); });

  document.getElementById("manage").addEventListener("click", openManage);

  viewListBtn.addEventListener("click", () => setView("list"));
  viewCalBtn.addEventListener("click", () => setView("cal"));

  sortPlanBtn.addEventListener("click", () => setSort("plan"));
  sortLongBtn.addEventListener("click", () => setSort("long"));
  sortShortBtn.addEventListener("click", () => setSort("short"));

  // Calendar nav (desktop week)
  calPrev.addEventListener("click", () => {
    const a = getCalAnchor();
    const prev = new Date(a.getFullYear(), a.getMonth(), a.getDate()-7);
    setCalAnchor(prev);
    render();
  });
  calNext.addEventListener("click", () => {
    const a = getCalAnchor();
    const next = new Date(a.getFullYear(), a.getMonth(), a.getDate()+7);
    setCalAnchor(next);
    render();
  });
  calToday.addEventListener("click", () => {
    const t = startOfDay(new Date());
    setCalAnchor(t);
    render();
  });

  // Mobile day nav
  mPrev.addEventListener("click", () => {
    const a = getMobileAnchor();
    const prev = new Date(a.getFullYear(), a.getMonth(), a.getDate()-1);
    setMobileAnchor(prev);
    render();
  });
  mNext.addEventListener("click", () => {
    const a = getMobileAnchor();
    const next = new Date(a.getFullYear(), a.getMonth(), a.getDate()+1);
    setMobileAnchor(next);
    render();
  });
  mToday.addEventListener("click", () => {
    setMobileAnchor(startOfDay(new Date()));
    render();
  });

  // Swipe on mobile calendar
  let touchStartX = null;
  let touchStartY = null;
  mcal.addEventListener("touchstart", (e) => {
    if (!e.touches || !e.touches.length) return;
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
  }, {passive:true});

  mcal.addEventListener("touchend", (e) => {
    if (touchStartX === null || touchStartY === null) return;
    const t = e.changedTouches && e.changedTouches[0];
    if (!t) return;

    const dx = t.clientX - touchStartX;
    const dy = t.clientY - touchStartY;

    // horizontal swipe threshold
    if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy) * 1.4){
      const a = getMobileAnchor();
      const next = new Date(a.getFullYear(), a.getMonth(), a.getDate() + (dx < 0 ? 1 : -1));
      setMobileAnchor(next);
      render();
    }
    touchStartX = null;
    touchStartY = null;
  }, {passive:true});

  // Initialize view/sort
  setSort(state.sort);
  setView(state.view);

  // Load data
  load();
})();
</script>
</body>
</html>
