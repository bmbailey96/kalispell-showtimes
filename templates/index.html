<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalispell Showtimes</title>
  <style>
    :root{
      --bg:#0b0b0f;
      --panel:#10101a;
      --panel2:#141421;
      --border:#23233a;
      --text:#eaeaf2;
      --muted:rgba(234,234,242,.72);
      --muted2:rgba(234,234,242,.55);
      --accent:#9ad1ff;

      --bead:#161625;
      --beadBorder:#2b2b49;
      --beadDim:#0f0f19;

      --shadow: 0 8px 24px rgba(0,0,0,.35);

      --warnBg:#2a0f16;
      --warnBorder:#5a1b2a;
      --warnText:#ffd6de;

      --shortBg:#1a1a12;
      --shortBorder:#4b4420;
      --shortText:#fff1b8;

      --eventBg:#0f1a16;
      --eventBorder:#1f4b3b;
      --eventText:#bfffe7;

      --oneBg:#101a2b;
      --oneBorder:#274a7a;
      --oneText:#cfe6ff;

      --todayBg:#1d2a3a;
      --todayBorder:#6bb8ff;

      --sectionBg: rgba(20,20,33,.7);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:20px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* FULL WIDTH */
    .wrap{
      width: 100%;
      max-width: none;
      margin: 0;
    }

    h1{ margin:0 0 10px; font-size:26px; letter-spacing:.2px; }
    .sub{ opacity:.8; margin-bottom:18px; max-width: 110ch; }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin:16px 0 10px;
      padding:14px;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow: var(--shadow);
      width: 100%;
    }

    label{ opacity:.85; font-size:13px; }
    input[type="number"]{
      width:92px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--beadBorder);
      background:var(--beadDim);
      color:var(--text);
      outline:none;
    }

    .search{
      width: 240px;
      max-width: 48vw;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--beadBorder);
      background:var(--beadDim);
      color:var(--text);
      outline:none;
    }

    .btn{
      padding:9px 12px;
      border-radius:10px;
      border:1px solid var(--beadBorder);
      background:#1c1c2e;
      color:var(--text);
      cursor:pointer;
      user-select:none;
      font-size:13px;
      line-height:1;
      white-space:nowrap;
    }
    .btn:hover{ background:#23233a; }
    .btn.primary{
      border-color: rgba(154,209,255,.6);
      background: rgba(154,209,255,.10);
    }
    .btn.sort{ background:#161625; }
    .btn.sort.active{
      border-color: rgba(154,209,255,.7);
      background: rgba(154,209,255,.14);
    }

    .toggle{
      display:flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--beadBorder);
      background:#161625;
      cursor:pointer;
      font-size:13px;
      user-select:none;
      white-space:nowrap;
    }
    .toggle input{ accent-color: var(--accent); }

    .meta{
      font-size:13px;
      opacity:.75;
      margin:10px 0 18px;
      white-space:pre-wrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 900px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .section{
      margin: 18px 0 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--sectionBg);
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      box-shadow: var(--shadow);
    }
    .sectionTitle{
      margin:0;
      font-size: 14px;
      font-weight: 800;
      letter-spacing: .4px;
      text-transform: uppercase;
      opacity: .92;
    }
    .sectionHint{
      font-size: 12px;
      color: var(--muted2);
      white-space: nowrap;
    }

    .card{
      padding:14px 14px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--panel);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }

    .error{
      padding:14px;
      border-radius:12px;
      background:var(--warnBg);
      border:1px solid var(--warnBorder);
      color:var(--warnText);
      white-space:pre-wrap;
      box-shadow: var(--shadow);
    }

    /* ---------- CALENDAR MODE STYLES ---------- */
    .calTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin: 14px 0 10px;
      flex-wrap: wrap;
    }
    .calTitle{
      font-size: 18px;
      font-weight: 900;
      margin: 0;
    }
    .calNav{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .iconBtn{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid var(--beadBorder);
      background: rgba(15,15,25,.55);
      color: var(--text);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      user-select:none;
    }
    .iconBtn:hover{
      border-color: rgba(154,209,255,.55);
      background: rgba(154,209,255,.10);
    }
    .todayBtn{
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--beadBorder);
      background: rgba(15,15,25,.55);
      color: var(--text);
      cursor:pointer;
      font-weight: 800;
    }
    .todayBtn:hover{
      border-color: rgba(154,209,255,.55);
      background: rgba(154,209,255,.10);
    }

    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, minmax(140px, 1fr));
      gap: 12px;
      width: 100%;
      overflow-x: auto;
      padding-bottom: 8px;
    }

    .dayCol{
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(16,16,26,.75);
      box-shadow: var(--shadow);
      padding: 10px;
      min-height: 460px;
    }

    .dayHead{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      padding: 2px 2px 10px;
      border-bottom: 1px solid rgba(35,35,58,.6);
      margin-bottom: 10px;
    }
    .dayDow{
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .5px;
      opacity: .7;
      text-transform: uppercase;
    }
    .dayDate{
      font-size: 14px;
      font-weight: 900;
      opacity: .9;
    }

    /* THE FIX: readable calendar row */
    .calItem{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 8px 8px;
      border-radius: 12px;
      border: 1px solid rgba(35,35,58,.65);
      background: rgba(15,15,25,.55);
      margin-bottom: 8px;
      min-width: 0;
    }

    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(154,209,255,.9);
      box-shadow: 0 0 0 3px rgba(154,209,255,.10);
      flex: 0 0 auto;
    }
    .dot.soon{ background: rgba(255,120,150,.95); box-shadow: 0 0 0 3px rgba(255,120,150,.12); }
    .dot.short{ background: rgba(255,220,120,.95); box-shadow: 0 0 0 3px rgba(255,220,120,.10); }

    .calName{
      flex: 1 1 auto;
      min-width: 0;
      font-weight: 850;
      font-size: 13px;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: .95;
    }

    .calActions{
      display:flex;
      align-items:center;
      gap: 6px;
      flex: 0 0 auto;
    }

    .act{
      width: 26px;
      height: 26px;
      border-radius: 9px;
      border: 1px solid rgba(43,43,73,.75);
      background: rgba(10,10,16,.35);
      color: rgba(234,234,242,.75);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      line-height: 1;
    }
    .act:hover{
      color: var(--text);
      border-color: rgba(154,209,255,.55);
      background: rgba(154,209,255,.10);
    }
    .act.hide:hover{
      border-color: rgba(255,120,150,.55);
      background: rgba(255,120,150,.10);
    }

    .moreLink{
      display:block;
      margin-top: 6px;
      font-size: 12px;
      opacity: .65;
      cursor: pointer;
      user-select:none;
    }
    .moreLink:hover{ opacity: .9; }

    /* MOBILE */
    @media (max-width: 700px){
      body{ padding: 12px; }
      .calGrid{ grid-template-columns: repeat(7, minmax(220px, 1fr)); }
      .dayCol{ min-height: 420px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Kalispell Showtimes</h1>
    <div class="sub">
      Calendar mode is date based (not showtime times yet). If you want the full “4:45p” calendar later, we’ll upgrade the scraper.
    </div>

    <div class="controls">
      <label for="days">Days ahead</label>
      <input id="days" type="number" min="1" max="365" value="60" />

      <button class="btn primary" id="refresh">Refresh</button>
      <button class="btn" id="debug">Debug fetch</button>

      <input id="q" class="search" placeholder="search titles…" />

      <label class="toggle">
        <input id="grouped" type="checkbox" checked />
        grouped
      </label>

      <label class="toggle">
        <input id="onlySoon" type="checkbox" />
        only leaving soon
      </label>

      <label class="toggle">
        <input id="mutedBottom" type="checkbox" checked />
        muted to bottom
      </label>

      <span style="flex:1"></span>

      <button class="btn sort active" data-sort="plan">Plan</button>
      <button class="btn sort" data-sort="az">A Z</button>
      <button class="btn sort" data-sort="long">Long</button>

      <button class="btn" id="modeShort">Short</button>
      <button class="btn" id="modeList">List</button>
      <button class="btn" id="modeCal">Calendar</button>
    </div>

    <div id="meta" class="meta"></div>
    <div id="out"></div>
  </div>

  <script>
    const out = document.getElementById("out");
    const meta = document.getElementById("meta");
    const daysEl = document.getElementById("days");
    const onlySoonEl = document.getElementById("onlySoon");
    const groupedEl = document.getElementById("grouped");
    const mutedBottomEl = document.getElementById("mutedBottom");
    const qEl = document.getElementById("q");

    const sortButtons = Array.from(document.querySelectorAll(".btn.sort"));

    const HIDDEN_KEY = "kalispell_hidden_titles_v6";
    const MUTED_KEY  = "kalispell_muted_titles_v6";
    const MODE_KEY   = "kalispell_mode_v6";

    function loadSet(key){
      try{
        const raw = localStorage.getItem(key);
        const arr = raw ? JSON.parse(raw) : [];
        return new Set(Array.isArray(arr) ? arr : []);
      }catch{
        return new Set();
      }
    }
    function saveSet(key, set){
      localStorage.setItem(key, JSON.stringify(Array.from(set)));
    }

    let hiddenSet = loadSet(HIDDEN_KEY);
    let mutedSet  = loadSet(MUTED_KEY);

    function hideTitle(title){
      hiddenSet.add(title);
      saveSet(HIDDEN_KEY, hiddenSet);
      render();
    }
    function toggleMute(title){
      if(mutedSet.has(title)) mutedSet.delete(title);
      else mutedSet.add(title);
      saveSet(MUTED_KEY, mutedSet);
      render();
    }

    function escapeHtml(s) {
      return (s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function parseISODate(s){
      const [y,m,d] = s.split("-").map(Number);
      return new Date(y, m-1, d);
    }

    function daysBetween(a, b){
      const ms = 24*60*60*1000;
      const ua = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
      const ub = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());
      return Math.round((ub - ua)/ms);
    }

    function getToday(){
      const t = new Date();
      return new Date(t.getFullYear(), t.getMonth(), t.getDate());
    }

    function runCount(movie){
      return Array.isArray(movie.dates) ? movie.dates.length : (movie.run_length_days || 0);
    }

    function sortedDateObjs(movie){
      const arr = Array.isArray(movie.dates) ? movie.dates.slice() : [];
      arr.sort();
      return arr.map(parseISODate);
    }

    function getNextShowing(movie, today){
      const dates = sortedDateObjs(movie);
      for(const d of dates){
        if(daysBetween(today, d) >= 0) return d;
      }
      return null;
    }

    function getLastShowing(movie){
      const dates = sortedDateObjs(movie);
      return dates.length ? dates[dates.length - 1] : null;
    }

    function leavingSoon(movie, today){
      const last = getLastShowing(movie);
      if(!last) return false;
      return daysBetween(today, last) <= 3;
    }

    function isShort(movie){
      return runCount(movie) <= 3;
    }

    function matchesSearch(movie){
      const q = (qEl.value || "").trim().toLowerCase();
      if(!q) return true;
      return (movie.title || "").toLowerCase().includes(q);
    }

    function moviePassesFilters(movie, today){
      if(hiddenSet.has(movie.title)) return false;
      if(onlySoonEl.checked && !leavingSoon(movie, today)) return false;
      if(!matchesSearch(movie)) return false;
      return true;
    }

    let state = { sort: "plan", movies: [], generated_at: null, source: null, days_ahead: 60 };
    let mode = localStorage.getItem(MODE_KEY) || "calendar";

    function setMode(m){
      mode = m;
      localStorage.setItem(MODE_KEY, m);
      render();
    }

    document.getElementById("modeShort").addEventListener("click", ()=>setMode("short"));
    document.getElementById("modeList").addEventListener("click", ()=>setMode("list"));
    document.getElementById("modeCal").addEventListener("click", ()=>setMode("calendar"));

    function setSort(newSort){
      state.sort = newSort;
      sortButtons.forEach(b => b.classList.toggle("active", b.dataset.sort === newSort));
      render();
    }
    sortButtons.forEach(btn => btn.addEventListener("click", () => setSort(btn.dataset.sort)));

    function sortList(list, today){
      const arr = list.slice();
      if(state.sort === "az"){
        arr.sort((a,b) => (a.title||"").localeCompare(b.title||""));
      } else if(state.sort === "long"){
        arr.sort((a,b) => (runCount(b) - runCount(a)) || (a.title||"").localeCompare(b.title||""));
      } else {
        arr.sort((a,b) => {
          const an = getNextShowing(a,today);
          const bn = getNextShowing(b,today);
          const ad = an ? daysBetween(today, an) : 9999;
          const bd = bn ? daysBetween(today, bn) : 9999;
          const aSoon = leavingSoon(a,today) ? 0 : 1;
          const bSoon = leavingSoon(b,today) ? 0 : 1;
          return (ad - bd) || (aSoon - bSoon) || (runCount(a) - runCount(b)) || (a.title||"").localeCompare(b.title||"");
        });
      }

      if(mutedBottomEl.checked){
        const unmuted = arr.filter(m => !mutedSet.has(m.title));
        const muted = arr.filter(m => mutedSet.has(m.title));
        return unmuted.concat(muted);
      }
      return arr;
    }

    function attachHandlers(){
      document.querySelectorAll("[data-hide]").forEach(el=>{
        el.addEventListener("click", ()=>{
          const title = el.getAttribute("data-hide");
          hideTitle(title);
        });
      });
      document.querySelectorAll("[data-mute]").forEach(el=>{
        el.addEventListener("click", ()=>{
          const title = el.getAttribute("data-mute");
          toggleMute(title);
        });
      });
    }

    /* ---------- CALENDAR RENDER ---------- */

    function startOfWeek(d){
      const nd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const dow = nd.getDay(); // 0 sun
      nd.setDate(nd.getDate() - dow);
      return nd;
    }

    function fmtHeaderRange(weekStart){
      const end = new Date(weekStart);
      end.setDate(end.getDate() + 6);

      const optsA = { month:"short", day:"numeric" };
      const optsB = { month:"short", day:"numeric", year:"numeric" };

      const a = weekStart.toLocaleString(undefined, optsA);
      const b = end.toLocaleString(undefined, optsB);
      return `${a} – ${b}`;
    }

    function fmtDayLabel(d){
      const dow = d.toLocaleString(undefined, { weekday:"short" }).toUpperCase();
      const md = d.toLocaleString(undefined, { month:"short", day:"numeric" });
      return { dow, md };
    }

    function calItemHTML(title, dotClass){
      const safe = escapeHtml(title);
      const attr = title.replaceAll('"','&quot;');

      return `
        <div class="calItem" title="${safe}">
          <div class="dot ${dotClass}"></div>
          <div class="calName">${safe}</div>
          <div class="calActions">
            <div class="act" data-mute="${attr}" title="mute">−</div>
            <div class="act hide" data-hide="${attr}" title="hide">×</div>
          </div>
        </div>
      `;
    }

    function renderCalendar(movies, today){
      // build date->titles list for ONE WEEK view based on "today"
      let weekStart = startOfWeek(today);

      const controls = `
        <div class="calTop">
          <h2 class="calTitle">${escapeHtml(fmtHeaderRange(weekStart))}</h2>
          <div class="calNav">
            <button class="iconBtn" id="wkPrev" title="previous week">◀</button>
            <button class="todayBtn" id="wkToday">Today</button>
            <button class="iconBtn" id="wkNext" title="next week">▶</button>
          </div>
        </div>
      `;

      // map day ISO -> items
      const dayMap = new Map();
      for(let i=0;i<7;i++){
        const d = new Date(weekStart);
        d.setDate(d.getDate()+i);
        const key = d.toISOString().slice(0,10);
        dayMap.set(key, []);
      }

      // add movies for each listed date that falls inside the week
      for(const m of movies){
        if(!moviePassesFilters(m, today)) continue;
        if(mutedSet.has(m.title)) continue; // keep muted out of calendar to reduce noise

        const dates = sortedDateObjs(m);
        for(const dt of dates){
          const key = dt.toISOString().slice(0,10);
          if(dayMap.has(key)){
            const dotClass = leavingSoon(m, today) ? "soon" : (isShort(m) ? "short" : "");
            dayMap.get(key).push({ title: m.title, dotClass });
          }
        }
      }

      // sort each day’s titles A-Z
      for(const [k, arr] of dayMap.entries()){
        arr.sort((a,b)=>a.title.localeCompare(b.title));
      }

      // render columns
      let cols = "";
      for(let i=0;i<7;i++){
        const d = new Date(weekStart);
        d.setDate(d.getDate()+i);
        const key = d.toISOString().slice(0,10);
        const { dow, md } = fmtDayLabel(d);

        const items = dayMap.get(key);
        const maxShow = 10;
        const shown = items.slice(0, maxShow);
        const hidden = items.length - shown.length;

        const list = shown.length
          ? shown.map(x => calItemHTML(x.title, x.dotClass)).join("")
          : `<div style="opacity:.55;font-size:12px;padding:6px 2px;">nothing</div>`;

        const more = hidden > 0 ? `<div class="moreLink" data-more="${key}">+${hidden} more</div>` : "";

        cols += `
          <div class="dayCol">
            <div class="dayHead">
              <div class="dayDow">${dow}</div>
              <div class="dayDate">${md}</div>
            </div>
            <div class="dayBody" data-day="${key}">
              ${list}
              ${more}
            </div>
          </div>
        `;
      }

      out.innerHTML = controls + `<div class="calGrid">${cols}</div>`;
      attachHandlers();

      // hook week nav with a stored offset
      let wkOffset = parseInt(localStorage.getItem("kalispell_week_offset_v6") || "0", 10);

      function setWeekOffset(newOffset){
        wkOffset = newOffset;
        localStorage.setItem("kalispell_week_offset_v6", String(wkOffset));
        const t = getToday();
        t.setDate(t.getDate() + (wkOffset * 7));
        renderCalendar(state.movies, t);
      }

      document.getElementById("wkPrev").addEventListener("click", ()=>setWeekOffset(wkOffset - 1));
      document.getElementById("wkNext").addEventListener("click", ()=>setWeekOffset(wkOffset + 1));
      document.getElementById("wkToday").addEventListener("click", ()=>{
        localStorage.setItem("kalispell_week_offset_v6", "0");
        renderCalendar(state.movies, getToday());
      });

      // expand "+more"
      document.querySelectorAll("[data-more]").forEach(el=>{
        el.addEventListener("click", ()=>{
          const dayKey = el.getAttribute("data-more");
          const body = document.querySelector(`.dayBody[data-day="${dayKey}"]`);
          const all = dayMap.get(dayKey);
          body.innerHTML = all.map(x => calItemHTML(x.title, x.dotClass)).join("");
          attachHandlers();
        });
      });
    }

    /* ---------- LIST / SHORT PLACEHOLDERS (so buttons still do something) ---------- */

    function renderPlaceholder(kind){
      out.innerHTML = `<div class="error">${escapeHtml(kind + " mode is still here, but calendar is your main weapon right now. Click Calendar.")}</div>`;
    }

    function render(){
      const today = getToday();
      meta.textContent = `Generated: ${state.generated_at}   Source: ${state.source}   Days ahead: ${state.days_ahead}`;

      // apply sort to keep calendar consistent if you later use list mode
      const filtered = state.movies.filter(m => moviePassesFilters(m, today));
      if(filtered.length === 0){
        out.innerHTML = `<div class="error">Nothing to show. Everything is hidden or filters are too intense.</div>`;
        return;
      }

      if(mode === "calendar"){
        // apply week offset
        const wkOffset = parseInt(localStorage.getItem("kalispell_week_offset_v6") || "0", 10);
        const t = getToday();
        t.setDate(t.getDate() + (wkOffset * 7));
        renderCalendar(state.movies, t);
        return;
      }

      if(mode === "list") return renderPlaceholder("List");
      if(mode === "short") return renderPlaceholder("Short");
      return renderCalendar(state.movies, today);
    }

    async function load(){
      const days = Math.max(1, Math.min(365, parseInt(daysEl.value || "60", 10)));
      daysEl.value = String(days);

      out.innerHTML = "";
      meta.textContent = "Loading…";

      try{
        const res = await fetch(`/api/showtimes?days=${days}`, { cache: "no-store" });
        const data = await res.json();

        if(!res.ok || data.error){
          meta.textContent = "";
          out.innerHTML = `<div class="error">${escapeHtml("Error: " + (data.error || res.statusText) + "\\n\\nDebug:\\n" + JSON.stringify(data.debug || {}, null, 2))}</div>`;
          return;
        }

        state.movies = data.movies || [];
        state.generated_at = data.generated_at;
        state.source = data.source;
        state.days_ahead = data.days_ahead;

        render();
      }catch(e){
        meta.textContent = "";
        out.innerHTML = `<div class="error">${escapeHtml("Request failed: " + e)}</div>`;
      }
    }

    async function debugFetch(){
      out.innerHTML = "";
      meta.textContent = "Running debug…";
      try{
        const res = await fetch(`/api/debug_raw`, { cache: "no-store" });
        const data = await res.json();
        meta.textContent = "";
        out.innerHTML = `<div class="error">${escapeHtml(JSON.stringify(data, null, 2))}</div>`;
      }catch(e){
        meta.textContent = "";
        out.innerHTML = `<div class="error">${escapeHtml("Debug failed: " + e)}</div>`;
      }
    }

    document.getElementById("refresh").addEventListener("click", load);
    document.getElementById("debug").addEventListener("click", debugFetch);
    onlySoonEl.addEventListener("change", render);
    groupedEl.addEventListener("change", render);
    mutedBottomEl.addEventListener("change", render);
    qEl.addEventListener("input", render);

    // init
    load();
  </script>
</body>
</html>
